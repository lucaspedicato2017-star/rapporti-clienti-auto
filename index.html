<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Rapporti Clienti ‚Äì Reperibilit√†</title>

<meta name="theme-color" content="#0b1220" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="Reperibilit√†" />

<link rel="manifest" href="manifest.json" />

<style>

:root{
  --bg:#070a12;
  --card:rgba(15,23,42,.68);
  --text:#e5e7eb;
  --muted:#9aa7bd;
  --stroke:rgba(148,163,184,.14);

  --brand:#3b82f6;
  --brand2:#2563eb;
  --danger:#ef4444;
  --ok:#22c55e;
  --warn:#f59e0b;
  --pink:#ec4899;
  --violet:#8b5cf6;
  --teal:#14b8a6;

  --radius:18px;
  --shadow:0 22px 70px rgba(0,0,0,.48);
  --shadow2:0 12px 28px rgba(0,0,0,.38);

  --navH:64px;

    --navRealH: calc(var(--navH) + env(safe-area-inset-bottom));
/* superfici colorate */
  --surf-blue: rgba(59,130,246,.16);
  --surf-pink: rgba(236,72,153,.14);
  --surf-amber: rgba(245,158,11,.16);
  --surf-green: rgba(34,197,94,.14);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background:
    radial-gradient(1200px 900px at 8% -12%, rgba(59,130,246,.40), transparent 62%),
    radial-gradient(1000px 760px at 102% 10%, rgba(236,72,153,.26), transparent 64%),
    radial-gradient(980px 780px at 22% 112%, rgba(20,184,166,.22), transparent 62%),
    radial-gradient(860px 640px at 70% 120%, rgba(139,92,246,.22), transparent 64%),
    linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,0) 42%),
    var(--bg);
  color:var(--text);
  -webkit-tap-highlight-color: transparent;
}

a{color:inherit}

.hidden{display:none!important}

.app-shell{
  min-height:100dvh;
  padding-top:calc(env(safe-area-inset-top));
  padding-bottom:calc(var(--navRealH) + 12px);
}

/* Top bar */
.topbar{
  position:sticky;
  top:0;
  z-index:1200;
  padding:12px 12px 10px;
  background:linear-gradient(180deg, rgba(15,23,42,.78), rgba(15,23,42,.62));
  backdrop-filter: blur(12px);
  border-bottom:1px solid rgba(148,163,184,.16);
}
.toprow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.brand{
  display:flex; align-items:center; gap:10px;
  font-weight:1000;
}
.logo{
  width:34px;height:34px;border-radius:12px;
  background:linear-gradient(135deg, rgba(59,130,246,1), rgba(37,99,235,1));
  box-shadow: 0 14px 26px rgba(37,99,235,.25);
  display:flex;align-items:center;justify-content:center;
  color:#fff;font-weight:1000;
}
.title{
  display:flex;flex-direction:column;line-height:1.05;
}
.title .t1{font-size:15px}
.title .t2{font-size:12px;color:var(--muted);font-weight:900;margin-top:2px}
.pill{
  font-size:11px;
  font-weight:1000;
  color:var(--muted);
  background:rgba(15,23,42,.78);
  border:1px solid var(--stroke);
  padding:7px 10px;
  border-radius:999px;
  box-shadow: var(--shadow2);
  max-width: 92vw;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* Screens */
.screens{
  padding:12px;
  max-width:980px;
  margin:0 auto;
  background:transparent;
}
.screen{display:none; animation: fadeIn .14s ease-out;}
.screen.active{display:block}
@keyframes fadeIn{from{opacity:.3;transform:translateY(2px)}to{opacity:1;transform:none}}

/* Cards / Sections */
.card{
  background:var(--card);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);

  border:1px solid var(--stroke);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  overflow:hidden;
  margin-bottom:12px;
}
.cardhead{
  padding:12px 12px 10px;
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:10px;
  position:relative;
}
.cardhead::after{
  content:"";
  position:absolute;
  left:12px; right:12px; bottom:-1px;
  height:2px; border-radius:999px;
  background:rgba(148,163,184,.18);
}
.cardhead-left{display:flex; gap:10px; align-items:flex-start;}
.icon{
  width:34px;height:34px;border-radius:14px;
  display:flex;align-items:center;justify-content:center;
  font-weight:1000;
  background:rgba(2,6,23,.06);
  box-shadow:0 10px 18px rgba(2,6,23,.10);
}
.hgroup h3{margin:0;font-size:15px;font-weight:1000}
.hgroup .sub{margin-top:2px;font-size:12px;color:var(--muted);font-weight:900}
.cardbody{padding:12px}

/* Color themes */
.theme-auto .cardhead{background:linear-gradient(135deg, rgba(236,72,153,.22), rgba(37,99,235,.08), rgba(255,255,255,0));}
.theme-auto .icon{background:rgba(236,72,153,.18)}
.theme-auto .cardhead::after{background:linear-gradient(90deg, rgba(236,72,153,.55), rgba(37,99,235,.25), transparent);}

.theme-manual .cardhead{background:linear-gradient(135deg, rgba(37,99,235,.22), rgba(124,58,237,.08), rgba(255,255,255,0));}
.theme-manual .icon{background:rgba(37,99,235,.18)}
.theme-manual .cardhead::after{background:linear-gradient(90deg, rgba(37,99,235,.55), rgba(124,58,237,.22), transparent);}

.theme-gestione .cardhead{background:linear-gradient(135deg, rgba(245,158,11,.24), rgba(34,197,94,.08), rgba(255,255,255,0));}
.theme-gestione .icon{background:rgba(245,158,11,.20)}
.theme-gestione .cardhead::after{background:linear-gradient(90deg, rgba(245,158,11,.62), rgba(34,197,94,.18), transparent);}

.theme-clienti .cardhead{background:linear-gradient(135deg, rgba(34,197,94,.22), rgba(20,184,166,.08), rgba(255,255,255,0));}
.theme-clienti .icon{background:rgba(34,197,94,.18)}
.theme-clienti .cardhead::after{background:linear-gradient(90deg, rgba(34,197,94,.62), rgba(20,184,166,.18), transparent);}

.divider{height:1px;background:rgba(15,23,42,.08)}

/* Inputs */
textarea,input,select{
  width:100%;
  padding:12px 12px;
  border-radius:14px;
  border:1px solid rgba(148,163,184,.18);
  background:rgba(2,6,23,.45);
  color:var(--text);

  margin-bottom:10px;
  font-size:16px;
  outline:none;
}
textarea::placeholder,input::placeholder{color:rgba(148,163,184,.72)}
select{color:var(--text)}
textarea:focus,input:focus,select:focus{
  border-color:rgba(37,99,235,.55);
  box-shadow:0 0 0 4px rgba(37,99,235,.10);
}


/* Note: textarea espandibile (si apre "a tendina" quando tocchi) */
.noteExp{
  height:46px;
  min-height:46px;
  max-height:260px;
  transition: height .16s ease;
  resize: vertical;
}
.noteExp:focus{
  height:160px;
}

.row{display:flex; gap:10px; flex-wrap:wrap;}
.row > *{flex:1}
.actions{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}

/* Buttons */
button{
  border:none;
  border-radius:999px;
  padding:10px 14px;
  font-weight:1000;
  cursor:pointer;
  user-select:none;
}
button:active{transform:scale(.99)}
.btn-primary{background:linear-gradient(135deg, rgba(59,130,246,1), rgba(37,99,235,1)); color:#fff; box-shadow:0 12px 22px rgba(37,99,235,.22)}
.btn-secondary{background:rgba(148,163,184,.18); color:var(--text)}
.btn-danger{background:linear-gradient(135deg, #ef4444, var(--danger)); color:#fff; box-shadow:0 12px 22px rgba(220,38,38,.18)}
.btn-chip{
  background:linear-gradient(135deg, rgba(2,6,23,.92), rgba(2,6,23,.78));
  color:#fff;
  border-radius:14px;
  padding:10px 14px;
  min-width:56px;
  box-shadow:0 12px 22px rgba(2,6,23,.18);
}
.btn-soft{
  background:rgba(148,163,184,.12);
  border:1px solid rgba(148,163,184,.14);
  color:var(--text);
  box-shadow:0 10px 18px rgba(2,6,23,.06);
}

.small{font-size:12px}
.muted{color:var(--muted);font-weight:900}

/* LED */
.led{width:14px;height:14px;border-radius:50%;background:#9ca3af;display:inline-block;vertical-align:middle}
.led.ok{background:var(--ok);box-shadow:0 0 0 3px rgba(34,197,94,.22), 0 0 14px rgba(34,197,94,.55)}

/* Inbox / present lists */
.box-soft{
  background:rgba(15,23,42,.58);
  border:1px dashed rgba(148,163,184,.18);
  border-radius:16px;
  padding:10px;
  margin-top:10px;
}

/* Box con sfondo chiaro: testo pi√π leggibile */
.box-light{
  color:#0b1220;
}
.box-light .muted{
  color:rgba(17,24,39,.70);
}
.box-light .small{
  color:rgba(17,24,39,.78);
}
.kpi{
  display:flex; gap:8px; flex-wrap:wrap; align-items:center;
  margin-top:8px;
}
.kpi .chip{
  background:rgba(2,6,23,.35);
  border:1px solid rgba(148,163,184,.14);
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:1000;
  color:rgba(2,6,23,.78);
}
.inbox-item{
  background:rgba(2,6,23,.45);
  color:var(--text);

  border:1px solid rgba(15,23,42,.10);
  border-radius:16px;
  padding:10px;
  margin-top:10px;
  box-shadow: 0 12px 22px rgba(2,6,23,.06);
}
.inbox-title{font-weight:1000}
.inbox-sub{font-size:12px;color:var(--muted);margin-top:4px;font-weight:900}
.inbox-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.inbox-highlight{
  outline:4px solid rgba(37,99,235,.65);
  box-shadow:0 0 0 6px rgba(37,99,235,.10);
  animation:pulseHL 1.1s ease-in-out 0s 2;
}
@keyframes pulseHL{0%{transform:scale(1)}50%{transform:scale(1.01)}100%{transform:scale(1)}}

/* Customer cards */
.gc-card{border-radius:18px;padding:12px;margin-bottom:10px;position:relative;border:1px solid rgba(0,0,0,.06);box-shadow: 0 14px 28px rgba(2,6,23,.09)}
.gc-none{background:rgba(148,163,184,.10)}
.gc-telefonica{background:rgba(34,197,94,.18)}
.gc-richiamare{background:rgba(245,158,11,.18)}
.gc-da_richiamare{background:rgba(245,158,11,.14)}
.gc-uscita{background:rgba(59,130,246,.18)}
.gc-rifiutato{background:rgba(239,68,68,.18)}
.gc-ripartita{background:rgba(139,92,246,.18)}

.gc-title{font-size:18px;font-weight:1000}
.gc-big{font-size:16px;font-weight:900;margin-top:6px}
.gc-row{font-size:13px;margin-top:4px}
.gc-link{cursor:pointer;text-decoration:underline;color:inherit}
.gc-stato{
  position:absolute;top:10px;right:12px;
  font-size:12px;font-weight:1000;
  padding:4px 10px;border-radius:999px;
  background:linear-gradient(180deg, rgba(15,23,42,.78), rgba(15,23,42,.62));
  cursor:pointer;border:1px solid rgba(0,0,0,.06);
}
.gc-actions{display:flex;gap:8px;justify-content:center;margin-top:10px}

.gc-highlight{
  outline:4px solid rgba(37,99,235,.75);
  box-shadow:0 0 0 6px rgba(37,99,235,.12);
  animation:pulseHL 1.1s ease-in-out 0s 2;
}
.gc-highlight-sticky{
  outline:4px solid rgba(37,99,235,.75);
  box-shadow:0 0 0 6px rgba(37,99,235,.12);
}
.gc-complete{padding:14px}
.gc-complete .gc-title{font-size:19px}
.gc-complete .gc-big{font-size:17px}

/* Fullscreen */
.cards-fullscreen{
  position:fixed;left:0;top:0;right:0;bottom:0;
  background:var(--bg);
  z-index:9998;
  padding:12px;
  padding-top:calc(12px + env(safe-area-inset-top));
  padding-bottom:calc(12px + env(safe-area-inset-bottom));
  overflow:auto;
}
.cards-fullscreen #cards{
  display:grid;
  grid-template-columns:repeat(auto-fill, minmax(320px, 1fr));
  gap:12px;
}
.group-title{
  font-size:13px;font-weight:1000;
  padding:9px 10px;border-radius:14px;
  background:rgba(2,6,23,.30);
  margin:14px 0 10px;
  border:1px dashed rgba(148,163,184,.18);
}
.cards-fullscreen .group-title{grid-column:1 / -1}

/* Modal */
.modal-backdrop{
  position:fixed;left:0;top:0;right:0;bottom:0;
  background:rgba(0,0,0,.45);
  display:flex;align-items:center;justify-content:center;
  z-index:9999;
  padding:12px;
  padding-top:calc(12px + env(safe-area-inset-top));
  padding-bottom:calc(12px + env(safe-area-inset-bottom));
}
.modal{
  width:100%;max-width:480px;
  background:rgba(2,6,23,.45);
  color:var(--text);
border-radius:18px;padding:12px;
  max-height:calc(100dvh - 24px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
  overscroll-behavior:contain;
  box-shadow:0 22px 56px rgba(0,0,0,.18);
}
.modal h3{margin:0 0 10px}
.modal .btn-row{
  display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;
  position:sticky;bottom:0;
  background:rgba(2,6,23,.45);
  color:var(--text);

  padding:10px 12px calc(10px + env(safe-area-inset-bottom));
  margin:12px -12px -12px;
  border-top:1px solid rgba(148,163,184,.16);
}

/* Fase2 states */
.fase2-attesa{
  outline:3px solid rgba(245,158,11,.55);
  box-shadow:0 18px 40px rgba(245,158,11,.14);
}
.fase2-ok{
  outline:3px solid rgba(34,197,94,.55);
  box-shadow:0 18px 40px rgba(34,197,94,.14);
}

/* Toast */
.toast{
  position:fixed;left:50%;transform:translateX(-50%);
  bottom:calc(var(--navH) + 12px + env(safe-area-inset-bottom));
  z-index:10001;
  background:linear-gradient(135deg, rgba(2,6,23,.92), rgba(15,23,42,.92));
  color:#fff;
  padding:10px 12px;border-radius:16px;
  font-size:13px;font-weight:1000;
  max-width:min(560px, calc(100% - 24px));
  text-align:center;
  display:none;
}

/* Bottom nav */
.bottomnav{
  min-height:calc(var(--navH) + env(safe-area-inset-bottom));
  height:auto;

  position:fixed;
  left:0;right:0;bottom:0;
padding:10px 10px calc(10px + env(safe-area-inset-bottom));
  background:linear-gradient(180deg, rgba(15,23,42,.78), rgba(15,23,42,.62));
  border-top:1px solid rgba(148,163,184,.16);
  backdrop-filter: blur(12px);
  z-index:1400;
}
.navrow{
  max-width:980px;
  margin:0 auto;
  display:flex;
  gap:8px;
  align-items:stretch;
}
.navbtn{
  flex:1;
  border-radius:18px;
  padding:10px 10px;
  background:rgba(2,6,23,.35);
  border:1px solid rgba(148,163,184,.14);
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  font-weight:1000;
  position:relative;
}
.navbtn.active{
  background:linear-gradient(135deg, rgba(37,99,235,.28), rgba(37,99,235,.12));
  border-color:rgba(37,99,235,.40);
  box-shadow:0 16px 34px rgba(59,130,246,.18);
}
.navico{font-size:16px}
.navlbl{ font-size:13px; font-weight:950; color:#ffffff; letter-spacing:.01em; }
.badgeCount{
  position:absolute;
  top:6px;
  right:8px;
  background:linear-gradient(135deg, var(--pink), #db2777);
  color:#fff;
  font-size:11px;
  font-weight:1000;
  padding:2px 8px;
  border-radius:999px;
  box-shadow:0 10px 18px rgba(236,72,153,.22);
  display:none;
}
.badgeCount.show{display:block}

/* Small helper row for LED */
.ledrow{display:flex;align-items:center;gap:8px;flex-wrap:wrap}

/* ---- UX richieste (v47) ---- */
.kpi{gap:10px}
.kpi .chip{
  font-size:13px;
  padding:8px 12px;
  border-radius:999px;
  box-shadow:0 14px 28px rgba(0,0,0,.28);
}
.kpiNum{
  display:inline-block;
  font-weight:1000;
  font-size:14px;
  padding:0 2px;
}
#kpi_inbox{
  background:linear-gradient(135deg, rgba(59,130,246,.32), rgba(2,6,23,.35));
  border-color:rgba(59,130,246,.38);
  color:#eaf2ff;
}
#kpi_present{
  background:linear-gradient(135deg, rgba(239,68,68,.28), rgba(2,6,23,.35));
  border-color:rgba(239,68,68,.34);
  color:#ffecec;
}

/* Navbar pi√π visibile */
.bottomnav{ box-shadow: 0 -18px 50px rgba(0,0,0,.55); }
.navrow{gap:10px}
.navbtn{ padding:14px 12px; min-height:52px; }
.navico{font-size:18px}
.navlbl{ font-size:13px; font-weight:950; color:#ffffff; letter-spacing:.01em; }
.badgeCount{ top:6px; right:10px; font-size:12px; padding:3px 9px; }

/* Modale pi√π opaca (non si vede sotto) */
.modal-backdrop{ background:rgba(0,0,0,.78); }
.modal{ background:rgba(11,18,32,.98); }

/* Card clienti: note lunghe sempre a capo */
.gc-row{ overflow-wrap:anywhere; word-break:break-word; white-space:pre-wrap; }

/* Pi√π spazio tra indirizzo e telefono */
.gc-big{margin-top:10px}
.gc-big + .gc-big{margin-top:12px}

/* Bottone filtro attivo */
.btn-filter-active{
  background:linear-gradient(135deg, rgba(59,130,246,.35), rgba(37,99,235,.18));
  border:1px solid rgba(59,130,246,.40);
  color:var(--text);
  box-shadow:0 16px 34px rgba(59,130,246,.18);
}


/* ---- Extra UX (v47.1) ---- */

/* Bottom nav: testo pi√π leggibile */
.navbtn{ color:rgba(229,231,235,.95); }
.navlbl{ font-size:13px; font-weight:950; color:#ffffff; letter-spacing:.01em; }
.navbtn.active .navlbl{ font-size:13px; font-weight:950; color:#ffffff; letter-spacing:.01em; }
.navbtn.active .navico{ filter: drop-shadow(0 10px 16px rgba(59,130,246,.22)); }

/* Fase 2: evidenza pi√π forte */
.fase2-attesa{
  outline:4px solid rgba(245,158,11,.78) !important;
  box-shadow:0 0 0 8px rgba(245,158,11,.16), 0 22px 50px rgba(245,158,11,.12) !important;
}
.fase2-ok{
  outline:4px solid rgba(34,197,94,.78) !important;
  box-shadow:0 0 0 8px rgba(34,197,94,.16), 0 22px 50px rgba(34,197,94,.12) !important;
}



/* ---- Gestione: Cliente compatto (default) ---- */
#clienteBox.cliente-compact #via,
#clienteBox.cliente-compact #citta,
#clienteBox.cliente-compact #telefono,
#clienteBox.cliente-compact #modello,
#clienteBox.cliente-compact #idApp,
#clienteBox.cliente-compact #matricola{
  display:none !important;
}
#clienteBox.cliente-compact #nome{
  margin-bottom:0;
}

/* =========================
   FIX NAV OVERLAY
   - la bottom nav prima era pi√π "alta" del suo height (i bottoni sbordavano)
   - la porto ad altezza reale (auto) e uso quella per il padding dello scroll
   ========================= */
.bottomnav{
  height:auto !important;
}
/* =========================
   FIX SOLO AUTOMATICO + GESTIONE (NON TOCCA CLIENTI)
   - Evita il bug "non scrolla nulla" quando .screens √® flex-container
   - Aggiunge spazio finale cos√¨ la bottom-nav non copre gli ultimi elementi
   ========================= */
html:not([data-screen="clients"]) .screens{
  display:block;
  -webkit-overflow-scrolling: touch;
  padding-bottom: calc(24px + var(--navRealH, var(--navH)));
  scroll-padding-bottom: calc(24px + var(--navRealH, var(--navH)));
}
html:not([data-screen="clients"]) .screen{
  flex:none !important;
  min-height:auto !important;
}

</style>
</head>

<body>
<div id="toast" class="toast"></div>

<div class="app-shell">

  <div class="topbar">
    <div class="toprow" style="justify-content:center">
      <div id="headerStatus" class="pill">Aggiornato: ‚Äî</div>
    </div>
  </div>

  <main class="screens">

    <!-- SCREEN: AUTOMATICO -->
    <section id="screen_auto" class="screen">
      <div class="card theme-auto" id="autoBox">
        <div class="cardhead">
          <div class="cardhead-left">
            <div class="icon">üì•</div>
            <div class="hgroup">
              <h3>Automatico</h3>
              <div class="sub">SMS in attesa + avvisi scheda presente</div>
              <div class="kpi">
                <span class="chip" id="kpi_inbox">üì© 0 in attesa</span>
                <span class="chip" id="kpi_present">‚ö†Ô∏è 0 avvisi</span>
              </div>
            </div>
          </div>
        </div>
        <div class="cardbody">

          <!-- Schede gi√† presenti -->
          <div id="presentWrap" class="hidden box-soft box-light" style="background:rgba(254,242,242,.9);border-color:rgba(220,38,38,.25)">
            <div class="actions" style="justify-content:space-between">
              <div style="font-weight:1000">‚ö†Ô∏è Scheda presente</div>
              <div class="actions">
                <span id="presentCount" class="small muted"></span>
                <button id="clearPresentBtn" class="btn-danger">üóëÔ∏è Svuota avvisi</button>
              </div>
            </div>
            <div id="presentList"></div>
            <div class="small muted" style="margin-top:8px">
              Se arriva un SMS per un cliente gi√† in lista: <b>Mostra cliente</b> o <b>Elimina avviso</b>.
              Finch√© l‚Äôavviso resta, la card rimane evidenziata.
            </div>
          </div>

          <!-- Inbox -->
          <div id="inboxWrap" class="hidden box-soft">
            <div class="actions" style="justify-content:space-between">
              <div style="font-weight:1000">üì© SMS in attesa</div>
              <div class="actions">
                <span id="inboxCount" class="small muted"></span>
                <button id="clearInboxBtn" class="btn-danger">üóëÔ∏è Svuota</button>
              </div>
            </div>
            <div id="inboxList"></div>
            <div class="small muted" style="margin-top:8px">
              Tocca <b>Apri</b> su un SMS, poi seleziona <b>PROBLEMA</b> e <b>TIPO GESTIONE</b> e premi <b>Aggiungi</b>.
            </div>
          </div>

          <div id="autoEmpty" class="box-soft box-light" style="margin-top:0;background:rgba(255,255,255,.62)">
            <div style="font-weight:1000">Nessun SMS da gestire</div>            <div class="small muted" style="margin-top:6px">
              Quando arriva un SMS dall‚Äôautomazione, lo troverai qui in <b>SMS in attesa</b> oppure in <b>Scheda presente</b>.
            </div>
          </div>


        </div>
      </div>
    </section>

    <!-- SCREEN: GESTIONE -->
    <section id="screen_manage" class="screen active">

      <!-- FASE 1 (solo manuale) -->
      <div class="card theme-manual" id="fase1">
        <div class="cardhead">
          <div class="cardhead-left">
            <div class="icon">‚úçÔ∏è</div>
            <div class="hgroup">
              <h3>Incolla SMS (manuale)</h3>
              <div class="sub">Incolla un SMS e inizializza i campi</div>
            </div>
          </div>
          <div class="ledrow">
            <span id="led" class="led"></span>
            <span id="ledTxt" class="small" style="font-weight:1000;color:var(--muted)">Non inizializzato</span>
          </div>
        </div>
        <div class="cardbody">
          <textarea id="sms" placeholder="Incolla qui l'SMS..."></textarea>
          <div class="actions">
            <button id="initBtn" class="btn-primary">‚ñ∂Ô∏è Inizializza</button>
            <button id="clearSmsBtn" class="btn-secondary">üßπ Pulisci</button>
          </div>
        </div>
      </div>

      <!-- FASE 2 -->
      <div class="card theme-gestione" id="fase2">
        <div class="cardhead">
          <div class="cardhead-left">
            <div class="icon">üõ†Ô∏è</div>
            <div class="hgroup">
              <h3>Gestione</h3>
              <div class="sub">Compila e aggiungi cliente alla lista</div>
            </div>
          </div>
        </div>
        <div class="cardbody">

          <div class="actions" style="margin-bottom:10px">
            <button id="manualModeBtn" class="btn-secondary">‚úçÔ∏è Manuale</button>
            <button id="toggleCliente" class="btn-secondary">üëÅÔ∏è Mostra cliente</button>
            <button id="newClientBtn" class="btn-primary">‚ûï Nuovo cliente</button>
          </div>
<div id="clientMiniName" class="clientMiniName">‚Äî</div>

          <div id="clienteBox" class="cliente-compact">
            <input id="nome" placeholder="Nome">
            <input id="via" placeholder="Via">
            <input id="citta" placeholder="Comune">
            <input id="telefono" placeholder="Telefono" type="tel" inputmode="numeric" autocomplete="tel">
            <input id="modello" placeholder="Modello caldaia">

            <div class="row" style="margin-bottom:10px">
              <div style="flex:1;min-width:220px">
                <input id="idApp" placeholder="ID Apparecchio" inputmode="numeric" autocomplete="off" style="margin-bottom:0">
              </div>
              <div style="flex:0 0 auto">
                <button type="button" class="btn-chip" id="insA_idApp">A</button>
              </div>
            </div>

            <input id="matricola" placeholder="Matricola" inputmode="numeric" pattern="[0-9]*">
          </div>

          <select id="problema">
            <option value="">-- PROBLEMA --</option>
            <option>NO ACQUA CALDA</option>
            <option>RISCALDAMENTO NON VA</option>
            <option>RUMOROSA</option>
            <option>PERDITA D'ACQUA</option>
            <option>TUTTO FERMO</option>
            <option>ALTRO</option>
          </select>

          <input id="problemaAltro" class="hidden" placeholder="Scrivi il problema...">

          <select id="stato">
            <option value="">-- TIPO GESTIONE --</option>
            <option value="telefonica">GESTITA AL TELEFONO</option>
            <option value="richiamare">RICHIAMANO LORO</option>
            <option value="da_richiamare">DA RICHIAMARE</option>
            <option value="uscita">USCITA</option>
            <option value="rifiutato">RIFIUTATO</option>
            <option value="ripartita">RIPARTITA</option>
          </select>

          <textarea id="note" class="noteExp" placeholder="Note"></textarea>

          <div class="actions">
            <button id="addBtn" class="btn-primary">‚ûï Aggiungi alla lista</button>
            <button id="clearFieldsBtn" class="btn-secondary">üßπ Pulisci campi</button>
          </div>

        </div>
      </div>

    </section>

    <!-- SCREEN: CLIENTI -->
    <section id="screen_clients" class="screen">
      <div class="card theme-clienti" id="fase3">
        <div class="cardhead">
          <div class="cardhead-left">
            <div class="icon">üë•</div>
            <div class="hgroup">
              <h3>Clienti</h3>
              <div class="sub">Lista operativa + PDF WhatsApp</div>
            </div>
          </div>
        </div>
        <div class="cardbody">
          <div class="actions" style="margin-bottom:10px">
            <button class="btn-primary" onclick="generaPdfWhatsapp()">üì§ PDF WhatsApp</button>
            <button class="btn-secondary" id="filterUsciteBtn" type="button">üöó Solo uscite</button>
            <button class="btn-danger" onclick="cancellaTutto()">üóëÔ∏è Elimina tutto</button>
          </div>
          <div id="cards"></div>
        </div>
      </div>
    </section>

  </main>

  <nav class="bottomnav">
    <div class="navrow">
      <button class="navbtn" id="nav_auto" data-screen="auto" type="button">
        <span class="navico">üì•</span><span class="navlbl">Automatico</span>
        <span class="badgeCount" id="navBadgeAuto">0</span>
      </button>
      <button class="navbtn active" id="nav_manage" data-screen="manage" type="button">
        <span class="navico">üõ†Ô∏è</span><span class="navlbl">Gestione</span>
      </button>
      <button class="navbtn" id="nav_clients" data-screen="clients" type="button">
        <span class="navico">üë•</span><span class="navlbl">Clienti</span>
      </button>
    </div>
  </nav>

</div>

<div id="modalRoot" class="hidden"></div>

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<script>

/* =========================
   VERSIONE
   ========================= */
var APP_VERSION = "2025-12-31.v51";
var BUILD_LABEL = "2025-12-31 12:00";
var SW_VER = 51;

/* =========================
   HELPERS
   ========================= */
function $(id){ return document.getElementById(id); }


/* =========================
   NAV HEIGHT SYNC (evita che la bottom bar copra il fondo)
   ========================= */
function syncNavRealHeight(){
  try{
    var nav = document.querySelector(".bottomnav");
    if(!nav) return;
    var h = (nav.getBoundingClientRect ? nav.getBoundingClientRect().height : nav.offsetHeight) || 0;
    // margine extra per ombre/spazi e differenze browser
    h = Math.ceil(h + 10);
    document.documentElement.style.setProperty("--navRealH", h + "px");
  }catch(e){}
}
window.addEventListener("load", function(){
  syncNavRealHeight();
  requestAnimationFrame(syncNavRealHeight);
  setTimeout(syncNavRealHeight, 200);
});
window.addEventListener("resize", syncNavRealHeight, { passive:true });
window.addEventListener("orientationchange", syncNavRealHeight);

function safeTrim(s){ return (s||"").replace(/^\s+|\s+$/g,""); }
function pad2(n){ n=parseInt(n,10); return (n<10 ? "0"+n : ""+n); }
function cleanPhone(p){ return String(p||"").replace(/[^0-9+]/g,""); }
function normKey(s){ return safeTrim(String(s||"")).toLowerCase().replace(/\s+/g," "); }
function escapeHtml(s){
  s = String(s||"");
  return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}
function insertAtCursor(input, text){
  if(!input) return;
  try{
    input.focus();
    var start = (input.selectionStart ?? input.value.length);
    var end   = (input.selectionEnd ?? input.value.length);
    if (typeof input.setRangeText === "function") {
      input.setRangeText(text, start, end, "end");
    } else {
      var v = input.value || "";
      input.value = v.slice(0,start) + text + v.slice(end);
    }
  }catch(e){
    input.value = (input.value || "") + text;
  }
}

/* =========================
   DOM refs
   ========================= */
var sms = $("sms");
var initBtn = $("initBtn");
var clearSmsBtn = $("clearSmsBtn");
var led = $("led");
var ledTxt = $("ledTxt");

var fase1 = $("fase1");
var fase2 = $("fase2");
var fase3 = $("fase3");

var autoBox = $("autoBox");
var autoEmpty = $("autoEmpty");

var manualModeBtn = $("manualModeBtn");
var toggleCliente = $("toggleCliente");
var newClientBtn = $("newClientBtn");
var clearFieldsBtn = $("clearFieldsBtn");
var clienteBox = $("clienteBox");

var nome = $("nome");
var via = $("via");
var citta = $("citta");
var telefono = $("telefono");
var modello = $("modello");
var idApp = $("idApp");
var matricola = $("matricola");

var insA_idApp = $("insA_idApp");

var problema = $("problema");
var problemaAltro = $("problemaAltro");
var stato = $("stato");
var note = $("note");
var addBtn = $("addBtn");

var cards = $("cards");
var modalRoot = $("modalRoot");

var inboxWrap = $("inboxWrap");
var inboxList = $("inboxList");
var inboxCount = $("inboxCount");
var clearInboxBtn = $("clearInboxBtn");

var presentWrap = $("presentWrap");
var presentList = $("presentList");
var presentCount = $("presentCount");
var clearPresentBtn = $("clearPresentBtn");

var toastEl = $("toast");
var verBadge = $("verBadge");
var headerStatus = $("headerStatus");
var filterUsciteBtn = $("filterUsciteBtn");

var navBadgeAuto = $("navBadgeAuto");

var kpi_inbox = $("kpi_inbox");
var kpi_present = $("kpi_present");
if(insA_idApp && idApp){
  insA_idApp.onclick = function(){ insertAtCursor(idApp, "A"); };
}

/* =========================
   NAV (app-like)
   ========================= */
var screens = { auto: $("screen_auto"), manage: $("screen_manage"), clients: $("screen_clients") };
function setScreen(name){
  document.documentElement.dataset.screen = name;

  for(var k in screens){
    if(!screens[k]) continue;
    screens[k].classList.toggle("active", k === name);
  }

  $("nav_auto").classList.toggle("active", name === "auto");
  $("nav_manage").classList.toggle("active", name === "manage");
  $("nav_clients").classList.toggle("active", name === "clients");

  function hardTop(){
    try{
      // NON tocco lo scroll della pagina (html/body): lo scroll √® interno
      var wrap = document.querySelector("main.screens") || document.querySelector(".screens");
      if(wrap && name !== "clients") wrap.scrollTop = 0;

      // In Clienti porto la lista in alto SOLO quando apro Clienti dal menu
      // (quando apro da "Mostra cliente", ci pensa scrollToClientByKey)
      if(name === "clients" && !window.__gotoClientKey){
        var cwrap = $("cards");
        if(cwrap) cwrap.scrollTop = 0;
      }
    }catch(e){}
  }

  hardTop();
  requestAnimationFrame(hardTop);

  // Per Safari: il "ritardo" serve spesso nelle schermate con scroll generale,
  // ma in Clienti darebbe fastidio (fa risaltare lo scroll dopo un attimo).
  if(name !== "clients"){
    setTimeout(hardTop, 120);
  }
}

document.querySelectorAll(".navbtn").forEach(function(btn){
  btn.addEventListener("click", function(){
    var s = btn.getAttribute("data-screen");
    if(s) setScreen(s);
  });
});

/* =========================
   STATE
   ========================= */
var clients = [];
var fase2Armed = false;

var inbox = [];
var presentNotifs = [];
var selectedInboxIndex = -1;

var manualMode = false;
var newClientMode = false; // modalit√† inserimento cliente manuale (campi completi)

// filtro lista clienti ("Solo uscite")
var showOnlyUscite = false;

// gestione vista cliente (compatta di default)
function setClienteCompact(on){
  if(!clienteBox) return;
  clienteBox.classList.remove("hidden");
  clienteBox.classList.toggle("cliente-compact", !!on);
  updateToggleClienteLabel();
}
function isClienteCompact(){
  if(!clienteBox) return true;
  return clienteBox.classList.contains("cliente-compact");
}
function updateToggleClienteLabel(){
  if(!toggleCliente || !clienteBox) return;

  if(newClientMode){
    toggleCliente.textContent = "‚õî Esci";
    toggleCliente.classList.remove("btn-secondary");
    toggleCliente.classList.add("btn-danger");
    return;
  }

  toggleCliente.classList.remove("btn-danger");
  toggleCliente.classList.add("btn-secondary");
  toggleCliente.textContent = isClienteCompact() ? "üëÅÔ∏è Mostra cliente" : "üôà Nascondi cliente";
}



var inboxPulseTs = 0;
var presentPulseTs = 0;

/* =========================
   TOAST
   ========================= */
var toastTimer = null;
function showToast(msg){
  if(!toastEl) return;
  toastEl.textContent = msg;
  toastEl.style.display = "block";
  if(toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(function(){
    toastEl.style.display = "none";
  }, 2200);
}

/* =========================
   SALVATAGGIO
   ========================= */
function salvaDati(){ try{ localStorage.setItem("rapportiClienti", JSON.stringify(clients)); }catch(e){} touchUpdate(); }
function caricaDati(){
  try{
    var dati = localStorage.getItem("rapportiClienti");
    if(dati) clients = JSON.parse(dati) || [];
  }catch(e){ clients=[]; }
}

function salvaInbox(){ try{ localStorage.setItem("rapportiInbox", JSON.stringify(inbox)); }catch(e){} touchUpdate(); }
function caricaInbox(){
  try{
    var d = localStorage.getItem("rapportiInbox");
    if(d) inbox = JSON.parse(d) || [];
    for(var i=0;i<inbox.length;i++){ if(!inbox[i].count) inbox[i].count = 1; }
  }catch(e){ inbox=[]; }
}

function salvaPresent(){ try{ localStorage.setItem("rapportiPresentNotifs", JSON.stringify(presentNotifs)); }catch(e){} touchUpdate(); }
function caricaPresent(){
  try{
    var d = localStorage.getItem("rapportiPresentNotifs");
    if(d) presentNotifs = JSON.parse(d) || [];
    for(var i=0;i<presentNotifs.length;i++){ if(!presentNotifs[i].count) presentNotifs[i].count = 1; }
  }catch(e){ presentNotifs=[]; }
}

function salvaModo(){ try{ localStorage.setItem("rapportiManualMode", manualMode ? "1" : "0"); }catch(e){} }
function caricaModo(){ try{ manualMode = (localStorage.getItem("rapportiManualMode")==="1"); }catch(e){ manualMode=false; } }

/* =========================
   LABEL STATO
   ========================= */
function statoLabel(s){
  var map = {
    telefonica:"GESTITA AL TELEFONO",
    richiamare:"RICHIAMANO LORO",
    da_richiamare:"DA RICHIAMARE",
    uscita:"USCITA",
    rifiutato:"RIFIUTATO",
    ripartita:"RIPARTITA"
  };
  return map[s] || "DA DECIDERE";
}

/* =========================
   PARSE SMS
   ========================= */
function stripTecno(s){
  return String(s||"")
    .replace(/\bTECNO[-\s][A-Z√Ä-√ú0-9]+(?:[-\s][A-Z√Ä-√ú0-9]+)*\b/ig, " ")
    .replace(/\s+/g," ")
    .trim();
}
function parseSMS(t){
  var r={nome:"",via:"",citta:"",telefono:"",modello:"",idApparecchio:"",matricola:""};

  t = (t||"");
  t = t.replace(/\r?\n/g," ").replace(/\s+/g," ").trim();
  t = t.replace(/[‚Äì‚Äî]/g,"-").replace(/\s*-\s*/g," - ");
  t = stripTecno(t);

  function findPos(re){ var m = t.match(re); return m ? (m.index||0) : -1; }

  var telPos = findPos(/\bTel\.?\b/i);
  var modPos = findPos(/\bModello\b/i);
  var idPos  = findPos(/\bID\s*Apparecchio\b/i);
  var matPos = findPos(/\bMatricola\b/i);

  // TELEFONO
  if(telPos >= 0){
    var tail = t.slice(telPos);
    var mTel = tail.match(/\bTel\.?\s*[:\-]?\s*([+]?[\d\s]+)/i);
    if(mTel) r.telefono = mTel[1].replace(/\s+/g,"").trim();
  }else{
    var mMob = t.match(/\b(3\d{8,10})\b/);
    if(mMob) r.telefono = mMob[1];
  }

  // ID APPARECCHIO (lettere + numeri)
  if(idPos >= 0){
    var tailId = t.slice(idPos);
    var mId = tailId.match(/\bID\s*Apparecchio\b\s*[:\-]?\s*([0-9A-Za-z\/\-]+)/i);
    if(mId){
      r.idApparecchio = safeTrim(mId[1]).replace(/-+$/,"").trim();
    }
  }

  // MATRICOLA
  if(matPos >= 0){
    var tailMat = t.slice(matPos);
    var mMat = tailMat.match(/\bMatricola\b\s*[:\-]?\s*([0-9A-Za-z\-\/]+)/i);
    if(mMat) r.matricola = safeTrim(mMat[1]);
  }

  // MODELLO
  if(modPos >= 0){
    var end = t.length;
    var candidates = [];
    if(idPos > modPos) candidates.push(idPos);
    if(matPos > modPos) candidates.push(matPos);

    var dashIdPos = findPos(/-\s*ID\b/i);
    if(dashIdPos > modPos) candidates.push(dashIdPos);

    if(candidates.length) end = Math.min.apply(null, candidates);

    var modelChunk = t.slice(modPos, end);
    var mMod = modelChunk.match(/\bModello\b\s*[:\-]?\s*(.+)$/i);
    if(mMod) r.modello = safeTrim(mMod[1].replace(/\s*-\s*$/,"").trim());
  }

  // NOME + INDIRIZZO
  var pre = t;
  if(telPos > 0) pre = t.slice(0, telPos).trim();
  else if(modPos > 0) pre = t.slice(0, modPos).trim();

  var streetRe = /\b(via|viale|piazza|p\.za|corso|c\.so|strada|s\.da|largo|vicolo)\b/i;
  var mStreet = pre.match(streetRe);

  if(mStreet){
    var streetWord = mStreet[0];
    var streetIdx = pre.toLowerCase().indexOf(streetWord.toLowerCase());

    r.nome = safeTrim(pre.slice(0, streetIdx).replace(/\s+-\s*$/,"").trim());
    var addrFull = safeTrim(pre.slice(streetIdx).replace(/\s+-\s*$/,"").trim());

    var tokens = addrFull.split(" ").filter(Boolean);

    for(var z=0; z<tokens.length; z++){
      tokens[z] = tokens[z].replace(/^(\d+)\s*\/\s*([A-Za-z])$/,"$1$2");
    }
    for(var k=tokens.length-1; k>=1; k--){
      if(/^[A-Za-z]$/.test(tokens[k]) && /^\d+$/.test(tokens[k-1])){
        tokens[k-1] = tokens[k-1] + tokens[k];
        tokens.splice(k,1);
        break;
      }
    }
    function isCivico(tok){
      return /^\d+[A-Za-z]?(?:\/\d+)?$/.test(tok);
    }
    var civIdx = -1;
    for(var i=tokens.length-1; i>=1; i--){
      if(isCivico(tokens[i])) { civIdx = i; break; }
    }

    if(civIdx >= 0){
      r.via   = safeTrim(tokens.slice(0, civIdx+1).join(" ")).replace(/[,\-]+$/,"").trim();
      r.citta = safeTrim(tokens.slice(civIdx+1).join(" ")).replace(/[,\-]+$/,"").trim();
    }else{
      r.via = addrFull;
      r.citta = "";
    }
    if(/\b(id|matricola|apparecchio|modello|tel)\b/i.test(r.citta)){
      r.citta = "";
    }
  }else{
    r.nome = safeTrim(pre);
  }

  return r;
}

/* =========================
   CHIAVE CLIENTE
   ========================= */
function clientKeyFromFields(n,v,c,tel){
  var ph = cleanPhone(tel);
  if(ph) return "tel:" + ph;
  return "addr:" + normKey(n) + "|" + normKey(v) + "|" + normKey(c);
}
function clientKeyFromClientObj(c){ return clientKeyFromFields(c.nome,c.via,c.citta,c.telefono); }
function clientKeyFromParsed(d){ return clientKeyFromFields(d.nome,d.via,d.citta,d.telefono); }
function safeIdFromKey(key){
  var s = String(key||"");
  try{
    var b = btoa(unescape(encodeURIComponent(s))).replace(/=+/g,"").replace(/\+/g,"-").replace(/\//g,"_");
    return "card_" + b;
  }catch(e){
    return "card_" + s.replace(/[^a-z0-9]+/gi,"_").slice(0,80);
  }
}
function findClientIndexByKey(key){
  for(var i=0;i<clients.length;i++){
    if(clientKeyFromClientObj(clients[i]) === key) return i;
  }
  return -1;
}

/* =========================
   BADGE + KPI
   ========================= */
function updateAutoBadge(){
  if(!navBadgeAuto) return;
  var n = (inbox.length || 0) + (presentNotifs.length || 0);
  navBadgeAuto.textContent = String(n);
  navBadgeAuto.classList.toggle("show", n > 0);
  if(autoEmpty) autoEmpty.style.display = (n === 0) ? "block" : "none";
  if(kpi_inbox) kpi_inbox.textContent = "üì© " + (inbox.length || 0) + " in attesa";
  if(kpi_present) kpi_present.textContent = "‚ö†Ô∏è " + (presentNotifs.length || 0) + " avvisi";
}

/* =========================
   AUTOBOX VISIBILITY
   ========================= */
function updateAutoBoxVisibility(){
  if((presentNotifs.length || 0) === 0 && presentWrap) presentWrap.classList.add("hidden");
  if((inbox.length || 0) === 0 && inboxWrap) inboxWrap.classList.add("hidden");
  updateAutoBadge();
}

/* =========================
   HIGHLIGHT / SCROLL
   ========================= */
function highlightOnceByKey(key){
  var id = safeIdFromKey(key);
  var el = document.getElementById(id);
  if(!el) return;
  el.classList.add("gc-highlight");
  setTimeout(function(){ el.classList.remove("gc-highlight"); }, 2500);
}
function scrollToClientByKey(key){
  var id = safeIdFromKey(key);
  var el = document.getElementById(id);
  var wrap = $("cards");
  if(!el || !wrap) return;

  try{
    var rEl = el.getBoundingClientRect();
    var rW  = wrap.getBoundingClientRect();
    var top = (rEl.top - rW.top) + wrap.scrollTop;

    // centro l'elemento nel viewport dello scroller
    var target = top - (wrap.clientHeight/2) + (el.offsetHeight/2);
    if(target < 0) target = 0;

    wrap.scrollTo({ top: target, behavior: "smooth" });
  }catch(e){
    // fallback
    try{ el.scrollIntoView({behavior:"smooth", block:"center"}); }catch(e2){}
  }
}

/* =========================
   FASE 2 FEEDBACK
   ========================= */
function setFase2State(state){
  fase2.classList.remove("fase2-attesa","fase2-ok");
  if(state==="attesa") fase2.classList.add("fase2-attesa");
  if(state==="ok") fase2.classList.add("fase2-ok");
}
function armFase2(){ fase2Armed = true; setFase2State("attesa"); checkFase2Ready(); }
function disarmFase2(){ fase2Armed = false; setFase2State("normal"); }
function checkFase2Ready(){
  if(!fase2Armed) return;
  var problemOk = !!problema.value;
  if(problema.value === "ALTRO") problemOk = safeTrim(problemaAltro.value).length > 0;
  var statoOk = !!stato.value;
  if(problemOk && statoOk) setFase2State("ok");
  else setFase2State("attesa");
}

/* =========================
   LED
   ========================= */
function setLedOk(on){
  if(on){
    led.classList.add("ok");
    ledTxt.textContent = "‚úÖ Inizializzato";
    ledTxt.style.color = "#16a34a";
  }else{
    led.classList.remove("ok");
    ledTxt.textContent = "Non inizializzato";
    ledTxt.style.color = "var(--muted)";
  }
}

/* =========================
   MODALIT√Ä
   ========================= */

function enterNewClientMode(){
  newClientMode = true;

  // UI: nascondo la parte "Incolla SMS" e preparo i campi cliente completi
  if(fase1) fase1.classList.add("hidden");
  if(newClientBtn) newClientBtn.classList.add("hidden");

  if(clienteBox){
    clienteBox.classList.remove("hidden");
    setClienteCompact(false); // mostra tutti i campi
  }

  resetCampiGestione();
  if(sms) sms.value = "";
  setLedOk(false);
  armFase2();

  updateToggleClienteLabel();
}

function exitNewClientMode(){
  if(!newClientMode) return;
  newClientMode = false;

  resetUICompleta();
  applyMode();            // ripristina visibilit√† (fase1 + pulsanti)
  updateToggleClienteLabel();
}

function applyMode(){
  if(manualMode){
    fase1.classList.remove("hidden");
    newClientBtn.classList.remove("hidden");
    manualModeBtn.textContent = "‚ö° Modalit√† automatica";
  }else{
    fase1.classList.add("hidden");
    newClientBtn.classList.add("hidden");
    manualModeBtn.textContent = "‚úçÔ∏è Modalit√† manuale";
  }

  // Modalit√† "Nuovo cliente": incolla nascosto + bottone Nuovo nascosto
  if(newClientMode){
    if(fase1) fase1.classList.add("hidden");
    if(newClientBtn) newClientBtn.classList.add("hidden");
  }

  renderInbox();
  renderPresent();
  updateAutoBoxVisibility();
  updateToggleClienteLabel();
}
manualModeBtn.onclick = function(){
  if(newClientMode) exitNewClientMode();
  manualMode = !manualMode;
  salvaModo();
  applyMode();
};

/* =========================
   INBOX (x2/x3)
   ========================= */
function findInboxIndexByRaw(text){
  text = safeTrim(text);
  for(var i=0;i<inbox.length;i++){
    if(safeTrim(inbox[i].raw) === text) return i;
  }
  return -1;
}
function addSmsToInbox(text){
  text = safeTrim(text);
  if(!text) return;

  var idx = findInboxIndexByRaw(text);

  if(idx >= 0){
    var it = inbox[idx];
    it.count = (it.count || 1) + 1;
    it.ts = Date.now();
    inbox.splice(idx,1);
    inbox.unshift(it);

    inboxPulseTs = it.ts;
    salvaInbox();
    renderInbox();
    updateAutoBoxVisibility();
  updateToggleClienteLabel();
    showToast("üì© SMS gi√† in attesa (x" + it.count + ")");
    return;
  }

  var obj = { raw:text, ts:Date.now(), count:1 };
  inbox.unshift(obj);
  inboxPulseTs = obj.ts;

  salvaInbox();
  renderInbox();
  updateAutoBoxVisibility();
  updateToggleClienteLabel();
}
function renderInbox(){
  if(!inboxWrap) return;

  if(!inbox.length){
    inboxWrap.classList.add("hidden");
    if(inboxList) inboxList.innerHTML = "";
    if(inboxCount) inboxCount.textContent = "";
    updateAutoBoxVisibility();
  updateToggleClienteLabel();
    return;
  }

  inboxWrap.classList.remove("hidden");
  inboxCount.textContent = inbox.length + " in attesa";
  inboxList.innerHTML = "";

  for(var i=0;i<inbox.length;i++){
    (function(ii){
      var it = inbox[ii];
      if(!it.count) it.count = 1;

      var div = document.createElement("div");
      div.className = "inbox-item";
      if(it.ts === inboxPulseTs) div.classList.add("inbox-highlight");

      var preview = (it.raw||"").replace(/\s+/g," ").slice(0,140);
      var badge = (it.count > 1) ? (" <span style='font-weight:1000;color:#2563eb'>(x"+it.count+")</span>") : "";

      div.innerHTML =
        '<div class="inbox-title">SMS ‚Ä¢ ' + escapeHtml(preview) + badge + '</div>' +
        '<div class="inbox-sub">Tocca Apri per gestirlo</div>';

      var actions = document.createElement("div");
      actions.className = "inbox-actions";

      var openBtn = document.createElement("button");
      openBtn.className = "btn-primary";
      openBtn.textContent = "Apri";
      openBtn.onclick = function(){
        selectedInboxIndex = ii;
        loadFromSmsText(it.raw);
        setScreen("manage");
      };

      var delBtn = document.createElement("button");
      delBtn.className = "btn-danger";
      delBtn.textContent = "Elimina";
      delBtn.onclick = function(){
        showModal(function(m){
          m.innerHTML =
            '<h3>Eliminare questo SMS in attesa?</h3>'+
            '<div class="small" style="color:#6b7280;margin-bottom:10px">'+escapeHtml(preview)+'</div>'+
            '<div class="btn-row">'+
              '<button class="btn-secondary" id="noDelIn">NO</button>'+
              '<button class="btn-danger" id="siDelIn">SI</button>'+
            '</div>';
          m.querySelector("#noDelIn").onclick = closeModal;
          m.querySelector("#siDelIn").onclick = function(){
            inbox.splice(ii,1);
            if(selectedInboxIndex === ii) selectedInboxIndex = -1;
            salvaInbox();
            renderInbox();
            updateAutoBoxVisibility();
  updateToggleClienteLabel();
            closeModal();
          };
        });
      };

      actions.appendChild(openBtn);
      actions.appendChild(delBtn);
      div.appendChild(actions);
      inboxList.appendChild(div);
    })(i);
  }

  updateAutoBoxVisibility();
  updateToggleClienteLabel();
}
clearInboxBtn.onclick = function(){
  showModal(function(m){
    m.innerHTML =
      '<h3>Svuotare tutti gli SMS in attesa?</h3>'+
      '<div class="btn-row">'+
        '<button class="btn-secondary" id="noClr">NO</button>'+
        '<button class="btn-danger" id="siClr">SI</button>'+
      '</div>';
    m.querySelector("#noClr").onclick = closeModal;
    m.querySelector("#siClr").onclick = function(){
      inbox = [];
      selectedInboxIndex = -1;
      salvaInbox();
      renderInbox();
      updateAutoBoxVisibility();
  updateToggleClienteLabel();
      closeModal();
    };
  });
};

/* =========================
   SCHEDA PRESENTE (x2/x3 SOLO avvisi)
   ========================= */
function hasPresentKey(key){
  for(var i=0;i<presentNotifs.length;i++){
    if(presentNotifs[i].key === key) return i;
  }
  return -1;
}
function addPresentNotif(key, raw){
  raw = safeTrim(raw||"");
  if(!key) return;

  var idx = hasPresentKey(key);
  if(idx >= 0){
    var it = presentNotifs[idx];
    it.count = (it.count || 1) + 1;
    it.ts = Date.now();
    if(raw) it.raw = raw;

    presentNotifs.splice(idx,1);
    presentNotifs.unshift(it);
    presentPulseTs = it.ts;
  }else{
    var obj = { key:key, raw:raw, ts:Date.now(), count:1 };
    presentNotifs.unshift(obj);
    presentPulseTs = obj.ts;
  }
  salvaPresent();
  renderPresent();
  updateAutoBoxVisibility();
  updateToggleClienteLabel();
}
function removePresentAt(i){
  presentNotifs.splice(i,1);
  salvaPresent();
  renderPresent();
  render();
  updateAutoBoxVisibility();
  updateToggleClienteLabel();
}
function renderPresent(){
  if(!presentWrap) return;

  if(!presentNotifs.length){
    presentWrap.classList.add("hidden");
    if(presentList) presentList.innerHTML = "";
    if(presentCount) presentCount.textContent = "";
    updateAutoBoxVisibility();
  updateToggleClienteLabel();
    return;
  }

  presentWrap.classList.remove("hidden");
  presentCount.textContent = presentNotifs.length + " avvisi";
  presentList.innerHTML = "";

  for(var i=0;i<presentNotifs.length;i++){
    (function(ii){
      var it = presentNotifs[ii];
      if(!it.count) it.count = 1;

      var preview = (it.raw||"").replace(/\s+/g," ").slice(0,140);
      var badge = (it.count > 1) ? (" <span style='font-weight:1000;color:#dc2626'>(x"+it.count+")</span>") : "";

      var div = document.createElement("div");
      div.className = "inbox-item";
      if(it.ts === presentPulseTs) div.classList.add("inbox-highlight");

      div.innerHTML =
        '<div class="inbox-title">SCHEDA PRESENTE' + badge + ' ‚Ä¢ ' + escapeHtml(preview || it.key) + '</div>' +
        '<div class="inbox-sub">Elimina avviso oppure mostra cliente</div>';

      var actions = document.createElement("div");
      actions.className = "inbox-actions";

      var showBtn = document.createElement("button");
      showBtn.className = "btn-primary";
      showBtn.textContent = "Mostra cliente";
      showBtn.onclick = function(){
        render();
        window.__gotoClientKey = it.key;
        setScreen("clients");
        setTimeout(function(){
          scrollToClientByKey(it.key);
          highlightOnceByKey(it.key);
          // dopo la navigazione, rimuovo il flag
          setTimeout(function(){ window.__gotoClientKey = null; }, 250);
        }, 80);
      };

      var delBtn = document.createElement("button");
      delBtn.className = "btn-danger";
      delBtn.textContent = "Elimina avviso";
      delBtn.onclick = function(){ removePresentAt(ii); };

      actions.appendChild(showBtn);
      actions.appendChild(delBtn);
      div.appendChild(actions);

      presentList.appendChild(div);
    })(i);
  }

  updateAutoBoxVisibility();
  updateToggleClienteLabel();
}
clearPresentBtn.onclick = function(){
  showModal(function(m){
    m.innerHTML =
      '<h3>Svuotare tutti gli avvisi?</h3>'+
      '<div class="btn-row">'+
        '<button class="btn-secondary" id="noClrP">NO</button>'+
        '<button class="btn-danger" id="siClrP">SI</button>'+
      '</div>';
    m.querySelector("#noClrP").onclick = closeModal;
    m.querySelector("#siClrP").onclick = function(){
      presentNotifs = [];
      salvaPresent();
      renderPresent();
      render();
      updateAutoBoxVisibility();
  updateToggleClienteLabel();
      closeModal();
    };
  });
};

/* =========================
   LOAD DA SMS
   ========================= */
function loadFromSmsText(testo){
  var d = parseSMS(testo);

  clienteBox.classList.remove("hidden");
  setClienteCompact(true);

  nome.value = d.nome;
  via.value = d.via;
  citta.value = d.citta;
  telefono.value = d.telefono;
  modello.value = d.modello;
  idApp.value = d.idApparecchio;
  matricola.value = d.matricola;

  note.value = "";

  setLedOk(true);
  armFase2();
}

/* =========================
   INGRESSO SMS (URL)
   ========================= */
function readIncoming(){
  try{
    var smsText = "";
    var p = new URLSearchParams(window.location.search);
    smsText = p.get("sms") || "";

    if(!smsText){
      var h = (window.location.hash || "").replace(/^#/, "");
      if(h){
        var hp = new URLSearchParams(h);
        smsText = hp.get("sms") || "";
      }
    }
    return smsText;
  }catch(e){
    return "";
  }
}
function clearIncomingFromUrl(){
  try{ history.replaceState({}, document.title, window.location.pathname); }catch(e){}
}
function handleIncomingSmsFromUrl(){
  try{
    var smsText = readIncoming();
    if(!smsText) return;

    clearIncomingFromUrl();

    var parsed = parseSMS(smsText);
    var cKey = clientKeyFromParsed(parsed);
    var existingIdx = findClientIndexByKey(cKey);

    if(existingIdx >= 0){
      addPresentNotif(cKey, smsText);
      showToast("‚ö†Ô∏è SCHEDA PRESENTE: elimina avviso o mostra cliente");
      render();
      setScreen("auto");
      return;
    }

    addSmsToInbox(smsText);

    manualMode = false;
    salvaModo();
    applyMode();
    setScreen("auto");
  }catch(e){}
}

/* =========================
   RESET UI
   ========================= */
function resetCampiGestione(){
  nome.value="";
  via.value="";
  citta.value="";
  telefono.value="";
  modello.value="";
  idApp.value="";
  matricola.value="";
  problema.value="";
  problemaAltro.value="";
  problemaAltro.classList.add("hidden");
  stato.value="";
  note.value="";
}
function resetUICompleta(){
  resetCampiGestione();
  if(sms) sms.value="";
  setLedOk(false);
  clienteBox.classList.add("hidden");
  disarmFase2();
  selectedInboxIndex = -1;

  // se ero in "Nuovo cliente", esco automaticamente
  newClientMode = false;
  updateToggleClienteLabel();
}


/* =========================
   FASE 1
   ========================= */
if(initBtn) initBtn.onclick=function(){
  var testo = safeTrim(sms.value);
  if(!testo){
    alert("Incolla prima l'SMS.");
    return;
  }
  loadFromSmsText(testo);
};
if(clearSmsBtn) clearSmsBtn.onclick=function(){ resetUICompleta(); };

/* =========================
   FASE 2
   ========================= */
toggleCliente.onclick=function(){
  if(newClientMode){
    exitNewClientMode();
    return;
  }
  setClienteCompact(!isClienteCompact());
};
newClientBtn.onclick=function(){
  enterNewClientMode();
};

problema.onchange=function(){
  if(problema.value === "ALTRO"){
    problemaAltro.classList.remove("hidden");
    try{ problemaAltro.focus(); }catch(e){}
  }else{
    problemaAltro.value="";
    problemaAltro.classList.add("hidden");
  }
  checkFase2Ready();
};
problemaAltro.oninput=function(){ checkFase2Ready(); };
stato.onchange=function(){ checkFase2Ready(); };

clearFieldsBtn.onclick=function(){ resetUICompleta(); applyMode(); };

addBtn.onclick=function(){
  var problemOk = !!problema.value;
  if(problema.value === "ALTRO") problemOk = safeTrim(problemaAltro.value).length > 0;

  if(!problemOk || !stato.value){
    alert("Seleziona PROBLEMA e TIPO GESTIONE. Se scegli ALTRO, scrivi il problema.");
    return;
  }

  var problemaFinale = problema.value;
  if(problema.value === "ALTRO") problemaFinale = "ALTRO: " + safeTrim(problemaAltro.value);

  var newKey = clientKeyFromFields(nome.value, via.value, citta.value, telefono.value);
  if(findClientIndexByKey(newKey) >= 0){
    showToast("‚ö†Ô∏è Cliente gi√† presente: non aggiunto");
    render();
    highlightOnceByKey(newKey);
    return;
  }

  clients.push({
    nome:nome.value,
    via:via.value,
    citta:citta.value,
    telefono:telefono.value,
    modello:modello.value,
    idApparecchio:idApp.value,
    matricola:matricola.value,
    problema:problemaFinale,
    stato:stato.value,
    note:note.value
  });

  if(selectedInboxIndex >= 0){
    inbox.splice(selectedInboxIndex, 1);
    selectedInboxIndex = -1;
    salvaInbox();
    renderInbox();
  }

  salvaDati();
  render();
  resetUICompleta();
  applyMode();
  setScreen("clients");
};

/* =========================
   MODALI (lock scroll)
   ========================= */
var __scrollY = 0;
function lockBodyScroll(){
  try{
    var wrap = document.querySelector("main.screens") || document.querySelector(".screens");
    if(!wrap) return;
    __scrollY = wrap.scrollTop || 0;
    wrap.style.overflow = "hidden";
  }catch(e){}
}
function unlockBodyScroll(){
  try{
    var wrap = document.querySelector("main.screens") || document.querySelector(".screens");
    if(!wrap) return;
    wrap.style.overflow = "";
    wrap.scrollTop = __scrollY || 0;
  }catch(e){}
}
function showModal(build){
  modalRoot.innerHTML="";
  modalRoot.classList.remove("hidden");
  lockBodyScroll();

  var b=document.createElement("div");
  b.className="modal-backdrop";
  var m=document.createElement("div");
  m.className="modal";
  build(m);
  b.appendChild(m);
  modalRoot.appendChild(b);
}
function closeModal(){
  modalRoot.classList.add("hidden");
  modalRoot.innerHTML="";
  unlockBodyScroll();
}

/* =========================
   RENDER CLIENTI
   ========================= */
function row(t){
  var r=document.createElement("div");
  r.className="gc-row";
  r.textContent=t;
  return r;
}
function isCompleteClient(c){
  return !!(safeTrim(c.nome) && safeTrim(c.via) && safeTrim(c.citta) &&
            safeTrim(c.telefono) && safeTrim(c.modello) &&
            safeTrim(c.idApparecchio) && safeTrim(c.matricola));
}
function buildCard(c, i){
  var d=document.createElement("div");
  d.className="gc-card gc-"+(c.stato||"none");
  if(isCompleteClient(c)) d.classList.add("gc-complete");

  var cKey = clientKeyFromClientObj(c);
  d.id = safeIdFromKey(cKey);

  if(hasPresentKey(cKey) >= 0) d.classList.add("gc-highlight-sticky");

  var stEl=document.createElement("span");
  stEl.className="gc-stato";
  stEl.textContent=statoLabel(c.stato);
  stEl.onclick=function(){
    var s=document.createElement("select");
    s.innerHTML=stato.innerHTML;
    s.value=c.stato||"";
    stEl.parentNode.replaceChild(s, stEl);
    try{ s.focus(); }catch(e){}
    s.onchange=function(){ c.stato=s.value; render(); salvaDati(); };
  };
  d.appendChild(stEl);

  var title=document.createElement("div");
  title.className="gc-title";
  title.textContent=c.nome||"";
  d.appendChild(title);

  var addr = "";
  if(c.via) addr += c.via;
  if(c.citta) addr += (addr ? " - " : "") + c.citta;

  if(addr){
    var a=document.createElement("div");
    a.className="gc-big gc-link";
    a.textContent="üìç "+addr;
    a.onclick=function(){
      window.open("https://www.google.com/maps/search/?api=1&query="+encodeURIComponent(addr));
    };
    d.appendChild(a);
  }

  if(c.telefono){
    var clean = cleanPhone(c.telefono);
    var t=document.createElement("a");
    t.className="gc-big gc-link";
    t.textContent="üìû "+clean;
    t.href="tel:%2331%23"+clean;
    d.appendChild(t);
  }

  if(c.modello) d.appendChild(row("üî• Modello: "+c.modello));
  if(c.idApparecchio) d.appendChild(row("üÜî ID App.: "+c.idApparecchio));
  if(c.matricola) d.appendChild(row("üî¢ Matricola: "+c.matricola));
  if(c.problema) d.appendChild(row("‚ùó Problema: "+c.problema));
  if(c.note) d.appendChild(row("üìù Note: "+c.note));

  var act=document.createElement("div");
  act.className="gc-actions";

  var ed=document.createElement("button");
  ed.className="btn-secondary";
  ed.textContent="‚úèÔ∏è Modifica";
  ed.onclick=function(){ openEdit(i); };

  var del=document.createElement("button");
  del.className="btn-danger";
  del.textContent="üóëÔ∏è Elimina";
  del.onclick=function(){ openDelete(i); };

  act.appendChild(ed);
  act.appendChild(del);
  d.appendChild(act);

  return d;
}
function render(){
  cards.innerHTML="";

  // aggiorna pulsante filtro (se presente)
  if(filterUsciteBtn){
    filterUsciteBtn.textContent = showOnlyUscite ? "Mostra tutti" : "Solo uscite";
    filterUsciteBtn.classList.toggle("active", showOnlyUscite);
  }

  var order = [];
  var groups = {};

  for(var idx=0; idx<clients.length; idx++){
    var c = clients[idx];
    if(showOnlyUscite && (c.stato||"") !== "uscita") continue;

    var raw = safeTrim(c.citta);
    var key = raw ? raw.toLowerCase() : "__no_city__";

    if(!groups[key]){
      groups[key] = { label: raw || "SENZA COMUNE", items: [] };
      order.push(key);
    }
    groups[key].items.push({ c:c, idx:idx });
  }

  for(var k=0; k<order.length; k++){
    var key2 = order[k];
    var g = groups[key2];

    var header = document.createElement("div");
    header.className="group-title";
    header.textContent="üèòÔ∏è " + g.label;
    cards.appendChild(header);

    for(var j=0; j<g.items.length; j++){
      cards.appendChild(buildCard(g.items[j].c, g.items[j].idx));
    }
  }
}

/* =========================
   MODIFICA
   ========================= */
function openEdit(i){
  var c = clients[i];

  var probSel = "";
  var probAlt = "";
  if((c.problema||"").toUpperCase().indexOf("ALTRO:") === 0){
    probSel = "ALTRO";
    probAlt = (c.problema||"").substring(6).trim();
  }else{
    probSel = c.problema || "";
  }

  showModal(function(modal){
    modal.innerHTML =
      '<h3>Modifica cliente</h3>'+

      '<div class="row"><div class="small muted">Nome</div><input id="e_nome" value="'+escapeHtml(c.nome)+'"></div>'+
      '<div class="row"><div class="small muted">Via</div><input id="e_via" value="'+escapeHtml(c.via)+'"></div>'+
      '<div class="row"><div class="small muted">Comune</div><input id="e_citta" value="'+escapeHtml(c.citta)+'"></div>'+

      '<div class="row"><div class="small muted">Telefono</div>'+
        '<input id="e_telefono" type="tel" inputmode="numeric" autocomplete="tel" value="'+escapeHtml(c.telefono)+'">'+
      '</div>'+

      '<div class="row"><div class="small muted">Modello caldaia</div><input id="e_modello" value="'+escapeHtml(c.modello)+'"></div>'+

      '<div class="row"><div class="small muted">ID Apparecchio</div>'+
        '<div style="display:flex;gap:10px;align-items:stretch">'+
          '<input id="e_idapp" inputmode="numeric" autocomplete="off" value="'+escapeHtml(c.idApparecchio||"")+'" style="margin-bottom:0;flex:1">'+
          '<button type="button" class="btn-chip" id="insA_e_idapp">A</button>'+
        '</div>'+
      '</div>'+

      '<div class="row"><div class="small muted">Matricola</div>'+
        '<input id="e_matricola" inputmode="numeric" pattern="[0-9]*" value="'+escapeHtml(c.matricola||"")+'">'+
      '</div>'+

      '<div class="row"><div class="small muted">Problema</div><select id="e_problema">'+problema.innerHTML+'</select></div>'+

      '<div class="row" id="e_prob_alt_row" style="display:none">'+
        '<div class="small muted">Scrivi il problema</div>'+
        '<input id="e_problemaAltro" value="'+escapeHtml(probAlt)+'">'+
      '</div>'+

      '<div class="row"><div class="small muted">Tipo gestione</div><select id="e_stato">'+stato.innerHTML+'</select></div>'+
      '<div class="row"><div class="small muted">Note</div><textarea id="e_note" class="noteExp" placeholder="Note">'+escapeHtml(c.note)+'</textarea></div>'+

      '<div class="btn-row">'+
        '<button class="btn-secondary" id="annullaEdit">Annulla</button>'+
        '<button class="btn-primary" id="salvaEdit">Salva</button>'+
      '</div>';

    modal.querySelector("#e_stato").value = c.stato || "";
    modal.querySelector("#e_problema").value = probSel;

    var eId = modal.querySelector("#e_idapp");
    var btnA = modal.querySelector("#insA_e_idapp");
    if(btnA && eId){ btnA.onclick = function(){ insertAtCursor(eId, "A"); }; }

    function refreshAlt(){
      var v = modal.querySelector("#e_problema").value;
      var row = modal.querySelector("#e_prob_alt_row");
      if(v === "ALTRO"){
        row.style.display = "block";
      }else{
        row.style.display = "none";
        modal.querySelector("#e_problemaAltro").value = "";
      }
    }
    refreshAlt();
    modal.querySelector("#e_problema").onchange = refreshAlt;

    modal.querySelector("#annullaEdit").onclick = closeModal;

    modal.querySelector("#salvaEdit").onclick = function(){
      var newKey = clientKeyFromFields(
        modal.querySelector("#e_nome").value,
        modal.querySelector("#e_via").value,
        modal.querySelector("#e_citta").value,
        modal.querySelector("#e_telefono").value
      );
      for(var x=0;x<clients.length;x++){
        if(x!==i && clientKeyFromClientObj(clients[x]) === newKey){
          showToast("‚ö†Ô∏è Esiste gi√† un cliente con gli stessi dati");
          closeModal();
          render();
          highlightOnceByKey(newKey);
          return;
        }
      }

      c.nome = modal.querySelector("#e_nome").value;
      c.via = modal.querySelector("#e_via").value;
      c.citta = modal.querySelector("#e_citta").value;
      c.telefono = modal.querySelector("#e_telefono").value;
      c.modello = modal.querySelector("#e_modello").value;
      c.idApparecchio = modal.querySelector("#e_idapp").value;
      c.matricola = modal.querySelector("#e_matricola").value;

      var p = modal.querySelector("#e_problema").value;
      if(p === "ALTRO"){
        var txt = safeTrim(modal.querySelector("#e_problemaAltro").value);
        c.problema = txt ? ("ALTRO: " + txt) : "ALTRO";
      }else{
        c.problema = p;
      }

      c.stato = modal.querySelector("#e_stato").value;
      c.note = modal.querySelector("#e_note").value;

      closeModal();
      render();
      salvaDati();
    };
  });
}

/* =========================
   ELIMINA
   ========================= */
function openDelete(i){
  showModal(function(m){
    m.innerHTML=
      '<h3>Eliminare cliente?</h3>'+
      '<div class="btn-row">'+
        '<button class="btn-secondary" id="noDel">NO</button>'+
        '<button class="btn-danger" id="siDel">SI</button>'+
      '</div>';
    m.querySelector("#noDel").onclick = closeModal;
    m.querySelector("#siDel").onclick = function(){
      var cKey = clientKeyFromClientObj(clients[i]);
      var pIdx = hasPresentKey(cKey);
      if(pIdx >= 0){
        presentNotifs.splice(pIdx,1);
        salvaPresent();
        renderPresent();
      }
      clients.splice(i,1);
      closeModal();
      render();
      salvaDati();
      updateAutoBoxVisibility();
  updateToggleClienteLabel();
    };
  });
}
function cancellaTutto(){
  showModal(function(m){
    m.innerHTML=
      '<h3>Eliminare TUTTI i clienti?</h3>'+
      '<div class="btn-row">'+
        '<button class="btn-secondary" id="noAll">NO</button>'+
        '<button class="btn-danger" id="siAll">SI</button>'+
      '</div>';
    m.querySelector("#noAll").onclick = closeModal;
    m.querySelector("#siAll").onclick = function(){
      clients=[];
      presentNotifs=[];
      inbox=[];
      salvaDati(); salvaPresent(); salvaInbox();
      closeModal();
      render();
      renderInbox();
      renderPresent();
      updateAutoBoxVisibility();
  updateToggleClienteLabel();
    };
  });
}

/* =========================
   PDF
   ========================= */
function generaPdfWhatsapp(){
  if(!clients.length){
    alert("Nessun cliente");
    return;
  }
  if(!window.jspdf || !window.jspdf.jsPDF){
    alert("PDF non disponibile: jsPDF non caricato. Apri in Safari/Chrome con internet.");
    return;
  }
  var jsPDF = window.jspdf.jsPDF;
  var pdf = new jsPDF("l", "mm", "a4");
  if(typeof pdf.autoTable !== "function"){
    alert("PDF non disponibile: AutoTable non caricato.");
    return;
  }

  var giorni = ["Domenica","Luned√¨","Marted√¨","Mercoled√¨","Gioved√¨","Venerd√¨","Sabato"];
  var now = new Date();
  var dataLabel = giorni[now.getDay()] + " " + pad2(now.getDate()) + "/" + pad2(now.getMonth()+1) + "/" + String(now.getFullYear()).slice(-2);

  function statoColor(s){
    var map = {
      telefonica:   [220,252,231],
      richiamare:   [255,237,213],
      da_richiamare:[254,249,195],
      uscita:       [219,234,254],
      rifiutato:    [254,226,226],
      ripartita:    [237,233,254],
      "":           [229,231,235],
      none:         [229,231,235]
    };
    return map[s || ""] || [229,231,235];
  }

  pdf.setFontSize(14);
  pdf.text("RAPPORTI CLIENTI ‚Äì REPERIBILIT√Ä", 14, 14);
  pdf.setFontSize(11);
  pdf.text("Data: " + dataLabel + " ‚Ä¢ Versione: " + APP_VERSION, 14, 20);

  var head = [[ "NOME","INDIRIZZO","TELEFONO","MODELLO","ID APP","MATRICOLA","PROBLEMA","GESTIONE","NOTE" ]];
  var body = [];
  for(var i=0;i<clients.length;i++){
    var c = clients[i];
    var indirizzo = "";
    if(c.via) indirizzo += c.via;
    if(c.citta) indirizzo += (indirizzo ? " - " : "") + c.citta;

    body.push([
      c.nome || "",
      indirizzo,
      c.telefono || "",
      c.modello || "",
      c.idApparecchio || "",
      c.matricola || "",
      c.problema || "",
      statoLabel(c.stato),
      c.note || ""
    ]);
  }

  pdf.autoTable({
    head: head,
    body: body,
    startY: 24,
    styles: { fontSize: 9, cellPadding: 3, valign: "middle" },
    headStyles: { fillColor: [37, 99, 235], textColor: 255, fontStyle: "bold" },
    margin: { left: 10, right: 10 },
    didParseCell: function (data) {
      if (data.section === "body") {
        var rowIndex = data.row.index;
        var c = clients[rowIndex];
        var s = c ? c.stato : "";
        data.cell.styles.fillColor = statoColor(s);
        data.cell.styles.textColor = [0,0,0];
      }
    }
  });

  var blob = pdf.output("blob");
  var file = null;
  try { file = new File([blob], "rapporti-clienti.pdf", { type: "application/pdf" }); } catch(e){ file=null; }

  if(file && navigator.canShare && navigator.canShare({ files: [file] }) && navigator.share){
    navigator.share({ files: [file] }).catch(function(){ openPdfFallback(pdf, blob); });
  } else {
    openPdfFallback(pdf, blob);
  }
}
function openPdfFallback(pdf, blob){
  try{
    var url = URL.createObjectURL(blob);
    var w = window.open(url, "_blank");
    if(!w) window.location.href = url;
    return;
  }catch(e){}
  try{
    var dataUri = pdf.output("datauristring");
    window.location.href = dataUri;
  }catch(e2){
    try{ pdf.save("rapporti-clienti.pdf"); }catch(e3){ alert("Impossibile aprire il PDF su questo browser."); }
  }
}

/* =========================
   FULLSCREEN
   ========================= */
function toggleCardsFullscreen(){
  if(fase3.classList.contains("cards-fullscreen")){
    fase3.classList.remove("cards-fullscreen");
    $("fsBtn").textContent = "üñ•Ô∏è Schermo intero";
  } else {
    fase3.classList.add("cards-fullscreen");
    $("fsBtn").textContent = "‚ùå Esci";
  }
}

/* =========================
   VERSION BADGE
   ========================= */
function fmtDateTime(ts){
  var d = new Date(ts || Date.now());
  var dd = pad2(d.getDate());
  var mm = pad2(d.getMonth()+1);
  var yy = String(d.getFullYear()).slice(-2);
  var hh = pad2(d.getHours());
  var mi = pad2(d.getMinutes());
  return dd + "/" + mm + "/" + yy + " " + hh + ":" + mi;
}
var lastUpdateTs = Date.now();

function touchUpdate(){
  lastUpdateTs = Date.now();
  if(!headerStatus) return;
  headerStatus.textContent = "Aggiornato: " + fmtDateTime(lastUpdateTs) + " ‚Ä¢ SW:" + SW_VER;
}

/* =========================
   VERSION / HEADER
   ========================= */
function setVersionBadge(){
  // Mantengo il nome per compatibilit√†: aggiorna la pill in alto (data/ora + SW)
  touchUpdate();
}

/* =========================
   INIT
   ========================= */
caricaDati();
caricaInbox();
caricaPresent();
caricaModo();

if(localStorage.getItem("rapportiManualMode") === null){
  manualMode = false;
  salvaModo();
}

setVersionBadge();
render();
renderInbox();
renderPresent();
applyMode();
updateAutoBoxVisibility();
  updateToggleClienteLabel();

// filtro uscite
if(filterUsciteBtn){
  filterUsciteBtn.onclick = function(){
    showOnlyUscite = !showOnlyUscite;
    render();
    setScreen("clients");
  };
}

// cliente compatto di default
setClienteCompact(true);
updateToggleClienteLabel();

// schermo iniziale
if(inbox.length || presentNotifs.length) setScreen("auto");
else if(clients.length) setScreen("clients");
else setScreen("manage");

// 1) prova subito all‚Äôavvio
handleIncomingSmsFromUrl();

// 2) riprova quando cambia hash o l‚Äôapp torna attiva
window.addEventListener("hashchange", handleIncomingSmsFromUrl);
window.addEventListener("pageshow", handleIncomingSmsFromUrl);
window.addEventListener("focus", handleIncomingSmsFromUrl);
document.addEventListener("visibilitychange", function(){
  if(!document.hidden) handleIncomingSmsFromUrl();
});

/* =========================
   PWA: service worker
   ========================= */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", function () {
    navigator.serviceWorker.register("service-worker.js?v=" + SW_VER).catch(function(){});
  });
}

</script>

</body>
</html>
