<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Rapporti Clienti ‚Äì Reperibilit√†</title>

<meta name="theme-color" content="#2563eb" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="Reperibilit√†" />

<link rel="manifest" href="manifest.json" />

<style>
body{font-family:system-ui;background:#f3f4f6;margin:0}
.app{
  max-width:900px;margin:auto;
  padding:12px;
  padding-top:calc(12px + env(safe-area-inset-top));
  padding-bottom:calc(12px + env(safe-area-inset-bottom));
}
.card{background:#fff;border-radius:14px;padding:12px;margin-bottom:12px;box-shadow:0 4px 10px rgba(0,0,0,.08)}
textarea,input,select{width:100%;padding:10px;border-radius:10px;border:1px solid #d1d5db;margin-bottom:8px;font-size:16px}
button{border:none;border-radius:999px;padding:10px 14px;font-weight:700;cursor:pointer}
.btn-primary{background:#2563eb;color:#fff}
.btn-secondary{background:#e5e7eb}
.btn-danger{background:#dc2626;color:#fff}
.hidden{display:none}

/* LED */
.led{width:14px;height:14px;border-radius:50%;background:#9ca3af;display:inline-block;margin-left:8px;vertical-align:middle}
.led.ok{background:#22c55e;box-shadow:0 0 0 3px rgba(34,197,94,.25), 0 0 14px rgba(34,197,94,.6)}

/* CARD */
.gc-card{border-radius:12px;padding:12px;margin-bottom:10px;position:relative}
.gc-none{background:#e5e7eb}
.gc-telefonica{background:#dcfce7}
.gc-richiamare{background:#ffedd5}
.gc-da_richiamare{background:#fef9c3}
.gc-uscita{background:#dbeafe}
.gc-rifiutato{background:#fee2e2}
.gc-ripartita{background:#ede9fe}

.gc-title{font-size:18px;font-weight:900}
.gc-big{font-size:16px;font-weight:800;margin-top:6px}
.gc-row{font-size:13px;margin-top:4px}
.gc-link{cursor:pointer;text-decoration:underline;color:inherit}

.gc-stato{
  position:absolute;top:10px;right:12px;
  font-size:12px;font-weight:900;
  padding:3px 8px;border-radius:999px;
  background:rgba(255,255,255,.75);
  cursor:pointer;
}
.gc-actions{display:flex;gap:8px;justify-content:center;margin-top:10px}

.gc-highlight{
  outline:4px solid rgba(37,99,235,.75);
  box-shadow:0 0 0 6px rgba(37,99,235,.12);
  animation: pulseHL 1.1s ease-in-out 0s 2;
}
@keyframes pulseHL{
  0%{transform:scale(1)}
  50%{transform:scale(1.01)}
  100%{transform:scale(1)}
}
.gc-highlight-sticky{
  outline:4px solid rgba(37,99,235,.75);
  box-shadow:0 0 0 6px rgba(37,99,235,.12);
}

/* card completa */
.gc-complete{padding:14px}
.gc-complete .gc-title{font-size:19px}
.gc-complete .gc-big{font-size:17px}

/* MODALE */
.modal-backdrop{
  position:fixed;left:0;top:0;right:0;bottom:0;
  background:rgba(0,0,0,.45);
  display:flex; align-items:center; justify-content:center;
  z-index:9999;
  padding:12px;
  padding-top:calc(12px + env(safe-area-inset-top));
  padding-bottom:calc(12px + env(safe-area-inset-bottom));
}
.modal{width:100%; max-width:440px;background:#fff;border-radius:14px;padding:12px;}
.modal h3{margin:0 0 10px}
.modal .row{margin-bottom:8px}
.modal .btn-row{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
.small{font-size:12px}

/* FEEDBACK FASE 2 */
.fase2-attesa{background:#fff7ed;outline:3px solid rgba(251,146,60,.65);box-shadow:0 8px 20px rgba(251,146,60,.18);}
.fase2-ok{background:#f0fdf4;outline:3px solid rgba(34,197,94,.65);box-shadow:0 8px 20px rgba(34,197,94,.18);}

/* FULLSCREEN FASE 3 */
.cards-fullscreen{
  position:fixed;left:0;top:0;right:0;bottom:0;
  background:#f3f4f6;z-index:9998;
  padding:12px;
  padding-top:calc(12px + env(safe-area-inset-top));
  padding-bottom:calc(12px + env(safe-area-inset-bottom));
  overflow:auto;
}
.cards-fullscreen #cards{
  display:grid;
  grid-template-columns:repeat(auto-fill, minmax(320px, 1fr));
  gap:12px;
}
.group-title{
  font-size:14px;font-weight:900;
  padding:8px 10px;border-radius:12px;
  background:rgba(0,0,0,.05);
  margin:14px 0 8px;
}
.cards-fullscreen .group-title{ grid-column: 1 / -1; }

.inbox-item{
  background:#fff;border:1px solid #e5e7eb;border-radius:14px;
  padding:10px;margin-top:8px;
}
.inbox-title{font-weight:900}
.inbox-sub{font-size:12px;color:#6b7280;margin-top:4px}
.inbox-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}

.toast{
  position:fixed;left:50%;transform:translateX(-50%);
  bottom:calc(12px + env(safe-area-inset-bottom));
  z-index:10001;background:rgba(17,24,39,.92);color:#fff;
  padding:10px 12px;border-radius:14px;font-size:13px;font-weight:800;
  max-width:min(560px, calc(100% - 24px));text-align:center;display:none;
}
.version-badge{
  position:fixed;
  top:calc(8px + env(safe-area-inset-top));
  left:10px;z-index:10000;
  font-size:11px;font-weight:900;color:#6b7280;
  background:rgba(255,255,255,.85);
  border:1px solid #e5e7eb;padding:4px 8px;border-radius:999px;
  backdrop-filter: blur(6px);
}
</style>
</head>

<body>
<div id="verBadge" class="version-badge">Versione: ‚Äî</div>
<div id="toast" class="toast"></div>

<div class="app">

  <!-- FASE 1 -->
  <div class="card" id="fase1">
    <h3>1. Incolla SMS</h3>
    <textarea id="sms" placeholder="Incolla qui l'SMS..."></textarea>

    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <button id="initBtn" class="btn-primary">‚ñ∂Ô∏è Inizializza</button>
      <button id="clearSmsBtn" class="btn-secondary">üßπ Pulisci SMS</button>
      <span id="led" class="led"></span>
      <span id="ledTxt" style="font-weight:800;color:#6b7280">Non inizializzato</span>
    </div>
  </div>

  <!-- BOX AUTOMATICO FUORI FASE 2 -->
  <div class="card hidden" id="autoBox">
    <h3>üì• Automatico</h3>

    <div class="small" id="autoHint" style="color:#6b7280;margin:-2px 0 8px">
      ‚Äî
    </div>

    <!-- Schede gi√† presenti -->
    <div id="presentWrap" class="hidden" style="background:#fef2f2;border:1px dashed #fecaca;border-radius:14px;padding:10px;margin:10px 0">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <div style="font-weight:900">‚ö†Ô∏è Scheda presente</div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <span id="presentCount" class="small" style="color:#6b7280"></span>
          <button id="clearPresentBtn" class="btn-danger">üóëÔ∏è Svuota avvisi</button>
        </div>
      </div>
      <div id="presentList"></div>
      <div class="small" style="margin-top:8px;color:#6b7280">
        Se arriva un SMS per un cliente gi√† in lista: <b>Mostra cliente</b> o <b>Elimina avviso</b>.
        Finch√© l‚Äôavviso resta, la card rimane evidenziata.
      </div>
    </div>

    <!-- Inbox -->
    <div id="inboxWrap" class="hidden" style="background:#f9fafb;border:1px dashed #d1d5db;border-radius:14px;padding:10px;margin:10px 0">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <div style="font-weight:900">üì© SMS in attesa</div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <span id="inboxCount" class="small" style="color:#6b7280"></span>
          <button id="clearInboxBtn" class="btn-danger">üóëÔ∏è Svuota</button>
        </div>
      </div>
      <div id="inboxList"></div>
      <div class="small" style="margin-top:8px;color:#6b7280">
        Tocca <b>Apri</b> su un SMS, poi seleziona <b>PROBLEMA</b> e <b>TIPO GESTIONE</b> e premi <b>Aggiungi</b>.
      </div>
    </div>
  </div>

  <!-- FASE 2 -->
  <div class="card" id="fase2">
    <h3>2. Gestione</h3>

    <div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap">
      <button id="manualModeBtn" class="btn-secondary">‚úçÔ∏è Modalit√† manuale</button>
      <button id="toggleCliente" class="btn-secondary">üëÅÔ∏è Mostra cliente</button>
      <button id="newClientBtn" class="btn-primary">‚ûï Nuovo cliente</button>
    </div>

    <div id="clienteBox" class="hidden">
      <input id="nome" placeholder="Nome">
      <input id="via" placeholder="Via">
      <input id="citta" placeholder="Comune">
      <input id="telefono" placeholder="Telefono" type="tel" inputmode="numeric" autocomplete="tel">
      <input id="modello" placeholder="Modello caldaia">
      <input id="idApp" placeholder="ID Apparecchio" inputmode="numeric">
      <input id="matricola" placeholder="Matricola">
    </div>

    <select id="problema">
      <option value="">-- PROBLEMA --</option>
      <option>NO ACQUA CALDA</option>
      <option>RISCALDAMENTO NON VA</option>
      <option>RUMOROSA</option>
      <option>PERDITA D'ACQUA</option>
      <option>TUTTO FERMO</option>
      <option>ALTRO</option>
    </select>

    <input id="problemaAltro" class="hidden" placeholder="Scrivi il problema...">

    <select id="stato">
      <option value="">-- TIPO GESTIONE --</option>
      <option value="telefonica">GESTITA AL TELEFONO</option>
      <option value="richiamare">RICHIAMANO LORO</option>
      <option value="da_richiamare">DA RICHIAMARE</option>
      <option value="uscita">USCITA</option>
      <option value="rifiutato">RIFIUTATO</option>
      <option value="ripartita">RIPARTITA</option>
    </select>

    <input id="note" placeholder="Note">

    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button id="addBtn" class="btn-primary">‚ûï Aggiungi alla lista</button>
      <button id="clearFieldsBtn" class="btn-secondary">üßπ Pulisci campi</button>
    </div>
  </div>

  <!-- FASE 3 -->
  <div class="card" id="fase3">
    <h3>3. Clienti</h3>

    <div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap">
      <button class="btn-primary" onclick="generaPdfWhatsapp()">üì§ PDF WhatsApp</button>
      <button class="btn-secondary" id="fsBtn" onclick="toggleCardsFullscreen()">üñ•Ô∏è Schermo intero</button>
      <button class="btn-danger" onclick="cancellaTutto()">üóëÔ∏è Elimina tutto</button>
    </div>

    <div id="cards"></div>
  </div>

</div>

<div id="modalRoot" class="hidden"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<script>
/* ===== VERSIONE ===== */
var APP_VERSION  = "2025-12-28.v52";
var BUILD_LABEL  = "v52 iPhone-bridge";
var SW_VER       = 52;

/* ===== HELPERS ===== */
function $(id){ return document.getElementById(id); }
function safeTrim(s){ return (s||"").replace(/^\s+|\s+$/g,""); }
function pad2(n){ n=parseInt(n,10); return (n<10 ? "0"+n : ""+n); }
function cleanPhone(p){ return String(p||"").replace(/[^0-9+]/g,""); }
function normKey(s){ return safeTrim(String(s||"")).toLowerCase().replace(/\s+/g," "); }
function escapeHtml(s){
  s = String(s||"");
  return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}
function isStandalone(){
  // iOS: navigator.standalone
  return (window.matchMedia && window.matchMedia("(display-mode: standalone)").matches) || (navigator.standalone === true);
}

/* ===== DOM ===== */
var sms = $("sms");
var initBtn = $("initBtn");
var clearSmsBtn = $("clearSmsBtn");
var led = $("led");
var ledTxt = $("ledTxt");

var fase1 = $("fase1");
var fase2 = $("fase2");
var fase3 = $("fase3");

var autoBox = $("autoBox");
var autoHint = $("autoHint");

var manualModeBtn = $("manualModeBtn");
var toggleCliente = $("toggleCliente");
var newClientBtn = $("newClientBtn");
var clearFieldsBtn = $("clearFieldsBtn");
var clienteBox = $("clienteBox");

var nome = $("nome");
var via = $("via");
var citta = $("citta");
var telefono = $("telefono");
var modello = $("modello");
var idApp = $("idApp");
var matricola = $("matricola");

var problema = $("problema");
var problemaAltro = $("problemaAltro");
var stato = $("stato");
var note = $("note");
var addBtn = $("addBtn");

var cards = $("cards");
var modalRoot = $("modalRoot");

var inboxWrap = $("inboxWrap");
var inboxList = $("inboxList");
var inboxCount = $("inboxCount");
var clearInboxBtn = $("clearInboxBtn");

var presentWrap = $("presentWrap");
var presentList = $("presentList");
var presentCount = $("presentCount");
var clearPresentBtn = $("clearPresentBtn");

var toastEl = $("toast");
var verBadge = $("verBadge");

/* ===== STATE ===== */
var clients = [];
var fase2Armed = false;
var inbox = [];
var presentNotifs = [];
var selectedInboxIndex = -1;
var manualMode = false;

/* ===== TOAST ===== */
var toastTimer = null;
function showToast(msg){
  toastEl.textContent = msg;
  toastEl.style.display = "block";
  if(toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(function(){ toastEl.style.display = "none"; }, 2200);
}

/* ===== STORAGE ===== */
function salvaDati(){ try{ localStorage.setItem("rapportiClienti", JSON.stringify(clients)); }catch(e){} }
function caricaDati(){
  try{ var dati = localStorage.getItem("rapportiClienti"); if(dati) clients = JSON.parse(dati) || []; }catch(e){ clients=[]; }
}
function salvaInbox(){ try{ localStorage.setItem("rapportiInbox", JSON.stringify(inbox)); }catch(e){} }
function caricaInbox(){
  try{ var d = localStorage.getItem("rapportiInbox"); if(d) inbox = JSON.parse(d) || []; }catch(e){ inbox=[]; }
}
function salvaPresent(){ try{ localStorage.setItem("rapportiPresentNotifs", JSON.stringify(presentNotifs)); }catch(e){} }
function caricaPresent(){
  try{ var d = localStorage.getItem("rapportiPresentNotifs"); if(d) presentNotifs = JSON.parse(d) || []; }catch(e){ presentNotifs=[]; }
}
function salvaModo(){ try{ localStorage.setItem("rapportiManualMode", manualMode ? "1" : "0"); }catch(e){} }
function caricaModo(){ try{ manualMode = (localStorage.getItem("rapportiManualMode")==="1"); }catch(e){ manualMode=false; } }

/* ===== STATO LABEL ===== */
function statoLabel(s){
  var map = {
    telefonica:"GESTITA AL TELEFONO",
    richiamare:"RICHIAMANO LORO",
    da_richiamare:"DA RICHIAMARE",
    uscita:"USCITA",
    rifiutato:"RIFIUTATO",
    ripartita:"RIPARTITA"
  };
  return map[s] || "DA DECIDERE";
}

/* ===== PARSE SMS ===== */
function stripTecno(s){
  return String(s||"")
    .replace(/\bTECNO[-\s][A-Z√Ä-√ú0-9]+(?:[-\s][A-Z√Ä-√ú0-9]+)*\b/ig, " ")
    .replace(/\s+/g," ")
    .trim();
}
function parseSMS(t){
  var r={nome:"",via:"",citta:"",telefono:"",modello:"",idApparecchio:"",matricola:""};

  t = (t||"").replace(/\r?\n/g," ").replace(/\s+/g," ").trim();
  t = t.replace(/[‚Äì‚Äî]/g,"-").replace(/\s*-\s*/g," - ");
  t = stripTecno(t);

  function findPos(re){ var m=t.match(re); return m ? (m.index||0) : -1; }

  var telPos = findPos(/\bTel\.?\b/i);
  var modPos = findPos(/\bModello\b/i);
  var idPos  = findPos(/\bID\s*Apparecchio\b/i);
  var matPos = findPos(/\bMatricola\b/i);

  if(telPos >= 0){
    var tail = t.slice(telPos);
    var mTel = tail.match(/\bTel\.?\s*[:\-]?\s*([+]?[\d\s]+)/i);
    if(mTel) r.telefono = mTel[1].replace(/\s+/g,"").trim();
  }else{
    var mMob = t.match(/\b(3\d{8,10})\b/);
    if(mMob) r.telefono = mMob[1];
  }

  if(idPos >= 0){
    var tailId = t.slice(idPos);
    var mId = tailId.match(/\bID\s*Apparecchio\b\s*[:\-]?\s*([0-9]+)/i);
    if(mId) r.idApparecchio = safeTrim(mId[1]);
  }

  if(matPos >= 0){
    var tailMat = t.slice(matPos);
    var mMat = tailMat.match(/\bMatricola\b\s*[:\-]?\s*([0-9A-Za-z\-\/]+)/i);
    if(mMat) r.matricola = safeTrim(mMat[1]);
  }

  if(modPos >= 0){
    var end = t.length;
    var candidates = [];
    if(idPos > modPos) candidates.push(idPos);
    if(matPos > modPos) candidates.push(matPos);
    var dashIdPos = findPos(/-\s*ID\b/i);
    if(dashIdPos > modPos) candidates.push(dashIdPos);
    if(candidates.length) end = Math.min.apply(null, candidates);

    var modelChunk = t.slice(modPos, end);
    var mMod = modelChunk.match(/\bModello\b\s*[:\-]?\s*(.+)$/i);
    if(mMod) r.modello = safeTrim(mMod[1].replace(/\s*-\s*$/,"").trim());
  }

  var pre = t;
  if(telPos > 0) pre = t.slice(0, telPos).trim();
  else if(modPos > 0) pre = t.slice(0, modPos).trim();

  var streetRe = /\b(via|viale|piazza|p\.za|corso|c\.so|strada|s\.da|largo|vicolo)\b/i;
  var mStreet = pre.match(streetRe);

  if(mStreet){
    var streetWord = mStreet[0];
    var streetIdx = pre.toLowerCase().indexOf(streetWord.toLowerCase());

    r.nome = safeTrim(pre.slice(0, streetIdx).replace(/\s+-\s*$/,"").trim());
    var addrFull = safeTrim(pre.slice(streetIdx).replace(/\s+-\s*$/,"").trim());

    var tokens = addrFull.split(" ").filter(Boolean);

    for(var z=0; z<tokens.length; z++){
      tokens[z] = tokens[z].replace(/^(\d+)\s*\/\s*([A-Za-z])$/,"$1$2");
    }
    for(var k=tokens.length-1; k>=1; k--){
      if(/^[A-Za-z]$/.test(tokens[k]) && /^\d+$/.test(tokens[k-1])){
        tokens[k-1] = tokens[k-1] + tokens[k];
        tokens.splice(k,1);
        break;
      }
    }
    function isCivico(tok){ return /^\d+[A-Za-z]?(?:\/\d+)?$/.test(tok); }

    var civIdx = -1;
    for(var i=tokens.length-1; i>=1; i--){
      if(isCivico(tokens[i])) { civIdx = i; break; }
    }

    if(civIdx >= 0){
      r.via   = safeTrim(tokens.slice(0, civIdx+1).join(" "));
      r.citta = safeTrim(tokens.slice(civIdx+1).join(" "));
    }else{
      r.via = addrFull;
      r.citta = "";
    }

    if(/\b(id|matricola|apparecchio|modello|tel)\b/i.test(r.citta)) r.citta = "";
  }else{
    r.nome = safeTrim(pre);
  }

  return r;
}

/* ===== KEY/ID ===== */
function clientKeyFromFields(n,v,c,tel){
  var ph = cleanPhone(tel);
  if(ph) return "tel:" + ph;
  return "addr:" + normKey(n) + "|" + normKey(v) + "|" + normKey(c);
}
function clientKeyFromClientObj(c){ return clientKeyFromFields(c.nome,c.via,c.citta,c.telefono); }
function clientKeyFromParsed(d){ return clientKeyFromFields(d.nome,d.via,d.citta,d.telefono); }
function safeIdFromKey(key){
  var s = String(key||"");
  try{
    var b = btoa(unescape(encodeURIComponent(s))).replace(/=+/g,"").replace(/\+/g,"-").replace(/\//g,"_");
    return "card_" + b;
  }catch(e){
    return "card_" + s.replace(/[^a-z0-9]+/gi,"_").slice(0,80);
  }
}
function findClientIndexByKey(key){
  for(var i=0;i<clients.length;i++){
    if(clientKeyFromClientObj(clients[i]) === key) return i;
  }
  return -1;
}

/* =========================
   iPHONE BRIDGE (Cache Queue)
   ========================= */
var BRIDGE_CACHE = "rc-bridge-queue-v1";
var BRIDGE_PREFIX = "./__bridge__/sms/";
async function bridgePushSms(smsText){
  smsText = safeTrim(smsText);
  if(!smsText) return false;
  if(!("caches" in window)) return false;

  try{
    var cache = await caches.open(BRIDGE_CACHE);
    var id = Date.now() + "_" + Math.random().toString(16).slice(2);
    var req = new Request(BRIDGE_PREFIX + id, { method:"GET" });
    var res = new Response(JSON.stringify({ sms:smsText, ts:Date.now() }), {
      headers: { "Content-Type":"application/json" }
    });
    await cache.put(req, res);
    return true;
  }catch(e){
    return false;
  }
}
async function bridgeConsumeAll(){
  if(!("caches" in window)) return 0;
  var consumed = 0;
  try{
    var cache = await caches.open(BRIDGE_CACHE);
    var keys = await cache.keys();
    for(var i=0;i<keys.length;i++){
      var url = (keys[i] && keys[i].url) ? keys[i].url : "";
      if(url.indexOf("/__bridge__/sms/") === -1) continue;

      try{
        var res = await cache.match(keys[i]);
        if(res){
          var data = await res.json();
          var smsText = data && data.sms ? String(data.sms) : "";
          if(smsText){
            // ingest come fosse URL
            ingestSmsText(smsText);
            consumed++;
          }
        }
      }catch(e2){}
      try{ await cache.delete(keys[i]); }catch(e3){}
    }
  }catch(e){}
  return consumed;
}

/* ===== UI helpers ===== */
function updateAutoBoxVisibility(){
  if((presentNotifs.length || inbox.length)) autoBox.classList.remove("hidden");
  else autoBox.classList.add("hidden");
  autoHint.textContent =
    (isStandalone() ? "Modalit√†: APP Home" : "Modalit√†: Safari") +
    " ‚Ä¢ v" + APP_VERSION + " ‚Ä¢ SW:" + SW_VER;
}
function highlightOnceByKey(key){
  var el = document.getElementById(safeIdFromKey(key));
  if(!el) return;
  el.classList.add("gc-highlight");
  try{ el.scrollIntoView({behavior:"smooth", block:"center"}); }catch(e){}
  setTimeout(function(){ el.classList.remove("gc-highlight"); }, 2500);
}
function scrollToClientByKey(key){
  var el = document.getElementById(safeIdFromKey(key));
  if(!el) return;
  try{ el.scrollIntoView({behavior:"smooth", block:"center"}); }catch(e){}
}

/* ===== FEEDBACK FASE 2 ===== */
function setFase2State(state){
  fase2.classList.remove("fase2-attesa","fase2-ok");
  if(state==="attesa") fase2.classList.add("fase2-attesa");
  if(state==="ok") fase2.classList.add("fase2-ok");
}
function armFase2(){ fase2Armed = true; setFase2State("attesa"); checkFase2Ready(); try{ fase2.scrollIntoView(true); }catch(e){} }
function disarmFase2(){ fase2Armed = false; setFase2State("normal"); }
function checkFase2Ready(){
  if(!fase2Armed) return;
  var problemOk = !!problema.value;
  if(problema.value === "ALTRO") problemOk = safeTrim(problemaAltro.value).length > 0;
  var statoOk = !!stato.value;
  setFase2State((problemOk && statoOk) ? "ok" : "attesa");
}

/* ===== LED ===== */
function setLedOk(on){
  if(on){
    led.classList.add("ok");
    ledTxt.textContent = "‚úÖ Inizializzato";
    ledTxt.style.color = "#16a34a";
  }else{
    led.classList.remove("ok");
    ledTxt.textContent = "Non inizializzato";
    ledTxt.style.color = "#6b7280";
  }
}

/* ===== MODE ===== */
function applyMode(){
  if(manualMode){
    fase1.classList.remove("hidden");
    newClientBtn.classList.remove("hidden");
    manualModeBtn.textContent = "‚ö° Modalit√† automatica";
  }else{
    fase1.classList.add("hidden");
    newClientBtn.classList.add("hidden");
    manualModeBtn.textContent = "‚úçÔ∏è Modalit√† manuale";
  }
  renderInbox();
  renderPresent();
  updateAutoBoxVisibility();
}
manualModeBtn.onclick = function(){ manualMode = !manualMode; salvaModo(); applyMode(); };

/* ===== INBOX ===== */
function inboxHasRaw(text){
  text = safeTrim(text);
  for(var i=0;i<inbox.length;i++){
    if(safeTrim(inbox[i].raw) === text) return true;
  }
  return false;
}
function addSmsToInbox(text){
  text = safeTrim(text);
  if(!text) return;
  if(inboxHasRaw(text)) return;
  inbox.unshift({ raw:text, ts:Date.now() });
  salvaInbox();
  renderInbox();
  updateAutoBoxVisibility();
}
function renderInbox(){
  if(!inbox.length){
    inboxWrap.classList.add("hidden");
    inboxList.innerHTML = "";
    inboxCount.textContent = "";
    return;
  }
  inboxWrap.classList.remove("hidden");
  inboxCount.textContent = inbox.length + " in attesa";
  inboxList.innerHTML = "";

  for(var i=0;i<inbox.length;i++){
    (function(ii){
      var it = inbox[ii];
      var preview = (it.raw||"").replace(/\s+/g," ").slice(0,140);

      var div = document.createElement("div");
      div.className = "inbox-item";
      div.innerHTML =
        '<div class="inbox-title">SMS ‚Ä¢ ' + escapeHtml(preview) + '</div>' +
        '<div class="inbox-sub">Tocca Apri per gestirlo</div>';

      var actions = document.createElement("div");
      actions.className = "inbox-actions";

      var openBtn = document.createElement("button");
      openBtn.className = "btn-primary";
      openBtn.textContent = "Apri";
      openBtn.onclick = function(){ selectedInboxIndex = ii; loadFromSmsText(it.raw); };

      var delBtn = document.createElement("button");
      delBtn.className = "btn-danger";
      delBtn.textContent = "Elimina";
      delBtn.onclick = function(){
        showModal(function(m){
          m.innerHTML =
            '<h3>Eliminare questo SMS in attesa?</h3>'+
            '<div class="small" style="color:#6b7280;margin-bottom:10px">'+escapeHtml(preview)+'</div>'+
            '<div class="btn-row">'+
              '<button class="btn-secondary" id="noDelIn">NO</button>'+
              '<button class="btn-danger" id="siDelIn">SI</button>'+
            '</div>';
          m.querySelector("#noDelIn").onclick = closeModal;
          m.querySelector("#siDelIn").onclick = function(){
            inbox.splice(ii,1);
            if(selectedInboxIndex === ii) selectedInboxIndex = -1;
            salvaInbox();
            renderInbox();
            closeModal();
          };
        });
      };

      actions.appendChild(openBtn);
      actions.appendChild(delBtn);
      div.appendChild(actions);
      inboxList.appendChild(div);
    })(i);
  }
}
clearInboxBtn.onclick = function(){
  showModal(function(m){
    m.innerHTML =
      '<h3>Svuotare tutti gli SMS in attesa?</h3>'+
      '<div class="btn-row">'+
        '<button class="btn-secondary" id="noClr">NO</button>'+
        '<button class="btn-danger" id="siClr">SI</button>'+
      '</div>';
    m.querySelector("#noClr").onclick = closeModal;
    m.querySelector("#siClr").onclick = function(){
      inbox = [];
      selectedInboxIndex = -1;
      salvaInbox();
      renderInbox();
      closeModal();
    };
  });
};

/* ===== PRESENT ===== */
function hasPresentKey(key){
  for(var i=0;i<presentNotifs.length;i++){
    if(presentNotifs[i].key === key) return i;
  }
  return -1;
}
function addPresentNotif(key, raw){
  raw = safeTrim(raw||"");
  if(!key) return;

  var idx = hasPresentKey(key);
  if(idx >= 0){
    presentNotifs[idx].ts = Date.now();
    if(raw) presentNotifs[idx].raw = raw;
    var it = presentNotifs.splice(idx,1)[0];
    presentNotifs.unshift(it);
  }else{
    presentNotifs.unshift({ key:key, raw:raw, ts:Date.now() });
  }
  salvaPresent();
  renderPresent();
  updateAutoBoxVisibility();
}
function removePresentAt(i){
  presentNotifs.splice(i,1);
  salvaPresent();
  renderPresent();
  render();
  updateAutoBoxVisibility();
}
function renderPresent(){
  if(!presentNotifs.length){
    presentWrap.classList.add("hidden");
    presentList.innerHTML = "";
    presentCount.textContent = "";
    return;
  }

  presentWrap.classList.remove("hidden");
  presentCount.textContent = presentNotifs.length + " avvisi";
  presentList.innerHTML = "";

  for(var i=0;i<presentNotifs.length;i++){
    (function(ii){
      var it = presentNotifs[ii];
      var preview = (it.raw||"").replace(/\s+/g," ").slice(0,140);

      var div = document.createElement("div");
      div.className = "inbox-item";
      div.innerHTML =
        '<div class="inbox-title">SCHEDA PRESENTE ‚Ä¢ ' + escapeHtml(preview || it.key) + '</div>' +
        '<div class="inbox-sub">Elimina avviso oppure mostra cliente</div>';

      var actions = document.createElement("div");
      actions.className = "inbox-actions";

      var showBtn = document.createElement("button");
      showBtn.className = "btn-primary";
      showBtn.textContent = "Mostra cliente";
      showBtn.onclick = function(){ render(); scrollToClientByKey(it.key); };

      var delBtn = document.createElement("button");
      delBtn.className = "btn-danger";
      delBtn.textContent = "Elimina avviso";
      delBtn.onclick = function(){ removePresentAt(ii); };

      actions.appendChild(showBtn);
      actions.appendChild(delBtn);
      div.appendChild(actions);
      presentList.appendChild(div);
    })(i);
  }
}
clearPresentBtn.onclick = function(){
  showModal(function(m){
    m.innerHTML =
      '<h3>Svuotare tutti gli avvisi?</h3>'+
      '<div class="btn-row">'+
        '<button class="btn-secondary" id="noClrP">NO</button>'+
        '<button class="btn-danger" id="siClrP">SI</button>'+
      '</div>';
    m.querySelector("#noClrP").onclick = closeModal;
    m.querySelector("#siClrP").onclick = function(){
      presentNotifs = [];
      salvaPresent();
      renderPresent();
      render();
      closeModal();
    };
  });
};

/* ===== INGEST SMS (logica unica) ===== */
function ingestSmsText(smsText){
  smsText = safeTrim(smsText);
  if(!smsText) return;

  var parsed = parseSMS(smsText);
  var cKey = clientKeyFromParsed(parsed);
  var existingIdx = findClientIndexByKey(cKey);

  if(existingIdx >= 0){
    addPresentNotif(cKey, smsText);
    showToast("‚ö†Ô∏è SCHEDA PRESENTE: elimina avviso o mostra cliente");
    render();
    scrollToClientByKey(cKey);
    return;
  }

  addSmsToInbox(smsText);
  showToast("üì© SMS ricevuto: aggiunto in attesa");
  manualMode = false;
  salvaModo();
  applyMode();
}

/* ===== LOAD DA SMS (fase2) ===== */
function loadFromSmsText(testo){
  var d = parseSMS(testo);
  clienteBox.classList.remove("hidden");

  nome.value = d.nome;
  via.value = d.via;
  citta.value = d.citta;
  telefono.value = d.telefono;
  modello.value = d.modello;
  idApp.value = d.idApparecchio;
  matricola.value = d.matricola;

  note.value = "";
  setLedOk(true);
  armFase2();
}

/* ===== URL READ ===== */
function readIncomingSms(){
  try{
    var p = new URLSearchParams(window.location.search);
    var smsText = p.get("sms") || p.get("$sms") || "";
    if(!smsText){
      var rawHash = (window.location.hash || "").replace(/^#/, "");
      try{
        var hp = new URLSearchParams(rawHash);
        smsText = hp.get("sms") || hp.get("$sms") || "";
      }catch(e){ smsText = ""; }

      if(!smsText){
        var m = rawHash.match(/(?:^|[&?])\$?sms=([^&]+)/i);
        if(m && m[1]){
          smsText = decodeURIComponent(String(m[1]).replace(/\+/g, "%20"));
        }
      }
    }
    return smsText || "";
  }catch(e){ return ""; }
}
function clearIncomingSmsFromUrl(){
  try{ history.replaceState({}, document.title, window.location.pathname); }catch(e){}
}

/* ===== HANDLER URL ===== */
async function handleIncomingSmsFromUrl(){
  var smsText = readIncomingSms();
  if(!smsText) return;

  // anti doppio
  var last = localStorage.getItem("lastIncomingSmsKey") || "";
  if(last === smsText){
    clearIncomingSmsFromUrl();
    return;
  }
  localStorage.setItem("lastIncomingSmsKey", smsText);

  if(isStandalone()){
    // siamo gi√† nella Home App: ingest diretto
    ingestSmsText(smsText);
    clearIncomingSmsFromUrl();
    return;
  }

  // Safari: metti in bridge e apri l'app
  var ok = await bridgePushSms(smsText);
  clearIncomingSmsFromUrl();

  if(ok){
    showToast("‚úÖ Ricevuto. Apro l‚Äôapp in Home‚Ä¶");
    // prova ad aprire la webapp installata (webapp:// usa host)
    setTimeout(function(){
      try{
        var host = window.location.host;
        // IMPORTANT: webapp:// non garantisce path/query; usiamo solo host
        window.location.href = "webapp://" + host;
      }catch(e){}
    }, 350);
  }else{
    showToast("‚ö†Ô∏è Non riesco a passare all‚Äôapp. Apri l‚Äôapp e riprova.");
  }
}

/* ===== RESET + FASE1/2 ===== */
function resetCampiGestione(){
  nome.value=""; via.value=""; citta.value="";
  telefono.value=""; modello.value=""; idApp.value=""; matricola.value="";
  problema.value=""; problemaAltro.value=""; problemaAltro.classList.add("hidden");
  stato.value=""; note.value="";
}
function resetUICompleta(){
  resetCampiGestione();
  sms.value="";
  setLedOk(false);
  clienteBox.classList.add("hidden");
  disarmFase2();
  selectedInboxIndex = -1;
}

initBtn.onclick=function(){
  var testo = safeTrim(sms.value);
  if(!testo){ alert("Incolla prima l'SMS."); return; }
  loadFromSmsText(testo);
};
clearSmsBtn.onclick=function(){ resetUICompleta(); };

toggleCliente.onclick=function(){
  if(clienteBox.classList.contains("hidden")) clienteBox.classList.remove("hidden");
  else clienteBox.classList.add("hidden");
};
newClientBtn.onclick=function(){
  clienteBox.classList.remove("hidden");
  resetCampiGestione();
  sms.value="";
  setLedOk(false);
  armFase2();
};

problema.onchange=function(){
  if(problema.value === "ALTRO"){
    problemaAltro.classList.remove("hidden");
    try{ problemaAltro.focus(); }catch(e){}
  }else{
    problemaAltro.value="";
    problemaAltro.classList.add("hidden");
  }
  checkFase2Ready();
};
problemaAltro.oninput=function(){ checkFase2Ready(); };
stato.onchange=function(){ checkFase2Ready(); };

clearFieldsBtn.onclick=function(){ resetUICompleta(); applyMode(); };

addBtn.onclick=function(){
  var problemOk = !!problema.value;
  if(problema.value === "ALTRO") problemOk = safeTrim(problemaAltro.value).length > 0;
  if(!problemOk || !stato.value){
    alert("Seleziona PROBLEMA e TIPO GESTIONE. Se scegli ALTRO, scrivi il problema.");
    return;
  }

  var problemaFinale = problema.value;
  if(problema.value === "ALTRO") problemaFinale = "ALTRO: " + safeTrim(problemaAltro.value);

  var newKey = clientKeyFromFields(nome.value, via.value, citta.value, telefono.value);
  if(findClientIndexByKey(newKey) >= 0){
    showToast("‚ö†Ô∏è Cliente gi√† presente: non aggiunto");
    render();
    highlightOnceByKey(newKey);
    return;
  }

  clients.push({
    nome:nome.value,
    via:via.value,
    citta:citta.value,
    telefono:telefono.value,
    modello:modello.value,
    idApparecchio:idApp.value,
    matricola:matricola.value,
    problema:problemaFinale,
    stato:stato.value,
    note:note.value
  });

  if(selectedInboxIndex >= 0){
    inbox.splice(selectedInboxIndex, 1);
    selectedInboxIndex = -1;
    salvaInbox();
    renderInbox();
  }

  salvaDati();
  render();
  resetUICompleta();
  applyMode();
};

/* ===== MODALI ===== */
function showModal(build){
  modalRoot.innerHTML="";
  modalRoot.classList.remove("hidden");
  var b=document.createElement("div");
  b.className="modal-backdrop";
  var m=document.createElement("div");
  m.className="modal";
  build(m);
  b.appendChild(m);
  modalRoot.appendChild(b);
}
function closeModal(){ modalRoot.classList.add("hidden"); modalRoot.innerHTML=""; }

/* ===== RENDER CLIENTI ===== */
function row(t){
  var r=document.createElement("div");
  r.className="gc-row";
  r.textContent=t;
  return r;
}
function isCompleteClient(c){
  return !!(safeTrim(c.nome) && safeTrim(c.via) && safeTrim(c.citta) &&
            safeTrim(c.telefono) && safeTrim(c.modello) &&
            safeTrim(c.idApparecchio) && safeTrim(c.matricola));
}
function buildCard(c, i){
  var d=document.createElement("div");
  d.className="gc-card gc-"+(c.stato||"none");
  if(isCompleteClient(c)) d.classList.add("gc-complete");

  var cKey = clientKeyFromClientObj(c);
  d.id = safeIdFromKey(cKey);
  if(hasPresentKey(cKey) >= 0) d.classList.add("gc-highlight-sticky");

  var stEl=document.createElement("span");
  stEl.className="gc-stato";
  stEl.textContent=statoLabel(c.stato);
  stEl.onclick=function(){
    var s=document.createElement("select");
    s.innerHTML=stato.innerHTML;
    s.value=c.stato||"";
    stEl.parentNode.replaceChild(s, stEl);
    try{ s.focus(); }catch(e){}
    s.onchange=function(){ c.stato=s.value; render(); salvaDati(); };
  };
  d.appendChild(stEl);

  var title=document.createElement("div");
  title.className="gc-title";
  title.textContent=c.nome||"";
  d.appendChild(title);

  var addr = "";
  if(c.via) addr += c.via;
  if(c.citta) addr += (addr ? " - " : "") + c.citta;

  if(addr){
    var a=document.createElement("div");
    a.className="gc-big gc-link";
    a.textContent="üìç "+addr;
    a.onclick=function(){
      window.open("https://www.google.com/maps/search/?api=1&query="+encodeURIComponent(addr));
    };
    d.appendChild(a);
  }

  if(c.telefono){
    var clean = cleanPhone(c.telefono);
    var t=document.createElement("a");
    t.className="gc-big gc-link";
    t.textContent="üìû "+clean;
    t.href="tel:%2331%23"+clean;
    d.appendChild(t);
  }

  if(c.modello) d.appendChild(row("üî• Modello: "+c.modello));
  if(c.idApparecchio) d.appendChild(row("üÜî ID App.: "+c.idApparecchio));
  if(c.matricola) d.appendChild(row("üî¢ Matricola: "+c.matricola));
  if(c.problema) d.appendChild(row("‚ùó Problema: "+c.problema));
  if(c.note) d.appendChild(row("üìù Note: "+c.note));

  var act=document.createElement("div");
  act.className="gc-actions";

  var ed=document.createElement("button");
  ed.className="btn-secondary";
  ed.textContent="‚úèÔ∏è Modifica";
  ed.onclick=function(){ openEdit(i); };

  var del=document.createElement("button");
  del.className="btn-danger";
  del.textContent="üóëÔ∏è Elimina";
  del.onclick=function(){ openDelete(i); };

  act.appendChild(ed);
  act.appendChild(del);
  d.appendChild(act);

  return d;
}
function render(){
  cards.innerHTML="";
  var order = [];
  var groups = {};

  for(var idx=0; idx<clients.length; idx++){
    var c = clients[idx];
    var raw = safeTrim(c.citta);
    var key = raw ? raw.toLowerCase() : "__no_city__";
    if(!groups[key]){
      groups[key] = { label: raw || "SENZA COMUNE", items: [] };
      order.push(key);
    }
    groups[key].items.push({ c:c, idx:idx });
  }

  for(var k=0; k<order.length; k++){
    var key2 = order[k];
    var g = groups[key2];

    var header = document.createElement("div");
    header.className="group-title";
    header.textContent="üèòÔ∏è " + g.label;
    cards.appendChild(header);

    for(var j=0; j<g.items.length; j++){
      cards.appendChild(buildCard(g.items[j].c, g.items[j].idx));
    }
  }
}

/* ===== EDIT/DELETE (identico a prima - omesso qui per brevit√†) ===== */
/* Per non cambiare nulla della tua logica, lasciamo il resto come nella tua versione:
   - openEdit
   - openDelete
   - cancellaTutto
   - PDF
   - fullscreen
   (Se vuoi te li reincollo qui identici, ma non servono per il bug iPhone) */

function openEdit(i){ alert("openEdit: incolla qui la tua funzione completa (uguale v51)"); }
function openDelete(i){ alert("openDelete: incolla qui la tua funzione completa (uguale v51)"); }
function cancellaTutto(){ alert("cancellaTutto: incolla qui la tua funzione completa (uguale v51)"); }
function generaPdfWhatsapp(){ alert("PDF: incolla qui la tua funzione completa (uguale v51)"); }
function toggleCardsFullscreen(){
  if(fase3.classList.contains("cards-fullscreen")){
    fase3.classList.remove("cards-fullscreen");
    $("fsBtn").textContent = "üñ•Ô∏è Schermo intero";
  } else {
    fase3.classList.add("cards-fullscreen");
    $("fsBtn").textContent = "‚ùå Esci";
  }
}

/* ===== VERSION BADGE ===== */
function setVersionBadge(){
  verBadge.textContent = "Versione: " + APP_VERSION + " ‚Ä¢ " + BUILD_LABEL + " ‚Ä¢ SW:" + SW_VER;
}

/* ===== INIT ===== */
caricaDati();
caricaInbox();
caricaPresent();
caricaModo();

if(localStorage.getItem("rapportiManualMode") === null){
  manualMode = false;
  salvaModo();
}

setVersionBadge();
render();
renderInbox();
renderPresent();
applyMode();
updateAutoBoxVisibility();

(async function boot(){
  // 1) prima consuma eventuali SMS arrivati tramite bridge (Safari -> Home)
  var n = await bridgeConsumeAll();
  if(n) showToast("‚úÖ " + n + " SMS importato/i nell‚Äôapp");

  // 2) poi prova parametri URL
  await handleIncomingSmsFromUrl();
})();

// riprova quando torna attiva
window.addEventListener("hashchange", function(){ handleIncomingSmsFromUrl(); });
window.addEventListener("pageshow", function(){ handleIncomingSmsFromUrl(); });
window.addEventListener("focus", function(){ handleIncomingSmsFromUrl(); });
document.addEventListener("visibilitychange", function(){
  if(!document.hidden) handleIncomingSmsFromUrl();
});
</script>

<script>
  // service worker
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", function () {
      navigator.serviceWorker.register("service-worker.js?v=" + SW_VER).catch(function(){});
    });
  }
</script>

</body>
</html>
