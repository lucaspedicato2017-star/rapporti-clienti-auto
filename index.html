<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Rapporti Clienti ‚Äì Reperibilit√†</title>

<meta name="theme-color" content="#2563eb" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="Reperibilit√†" />
<link rel="manifest" href="manifest.json" />

<style>
body{font-family:system-ui;background:#f3f4f6;margin:0}
.app{
  max-width:900px;margin:auto;
  padding:12px;
  padding-top:calc(12px + env(safe-area-inset-top));
  padding-bottom:calc(84px + env(safe-area-inset-bottom));
}
.card{background:#fff;border-radius:14px;padding:12px;margin-bottom:12px;box-shadow:0 4px 10px rgba(0,0,0,.08)}
textarea,input,select{width:100%;padding:10px;border-radius:10px;border:1px solid #d1d5db;margin-bottom:8px;font-size:16px}
button{border:none;border-radius:999px;padding:10px 14px;font-weight:800;cursor:pointer}
.btn-primary{background:#2563eb;color:#fff}
.btn-secondary{background:#e5e7eb}
.btn-danger{background:#dc2626;color:#fff}
.hidden{display:none}
.small{font-size:12px}

/* LED */
.led{width:14px;height:14px;border-radius:50%;background:#9ca3af;display:inline-block;margin-left:8px;vertical-align:middle}
.led.ok{background:#22c55e;box-shadow:0 0 0 3px rgba(34,197,94,.25), 0 0 14px rgba(34,197,94,.6)}

/* CARD */
.gc-card{border-radius:12px;padding:12px;margin-bottom:10px;position:relative}
.gc-none{background:#e5e7eb}
.gc-telefonica{background:#dcfce7}
.gc-richiamare{background:#ffedd5}
.gc-da_richiamare{background:#fef9c3}
.gc-uscita{background:#dbeafe}
.gc-rifiutato{background:#fee2e2}
.gc-ripartita{background:#ede9fe}

.gc-title{font-size:18px;font-weight:900}
.gc-big{font-size:16px;font-weight:800;margin-top:6px}
.gc-row{font-size:13px;margin-top:4px}
.gc-link{cursor:pointer;text-decoration:underline;color:inherit}

.gc-stato{
  position:absolute;top:10px;right:12px;
  font-size:12px;font-weight:900;
  padding:3px 8px;border-radius:999px;
  background:rgba(255,255,255,.75);
  cursor:pointer;
}
.gc-actions{display:flex;gap:8px;justify-content:center;margin-top:10px}

/* Evidenziazione card */
.gc-highlight{
  outline:4px solid rgba(37,99,235,.75);
  box-shadow:0 0 0 6px rgba(37,99,235,.12);
  animation: pulseHL 1.1s ease-in-out 0s 2;
}
@keyframes pulseHL{0%{transform:scale(1)}50%{transform:scale(1.01)}100%{transform:scale(1)}}

/* MODALE */
.modal-backdrop{
  position:fixed;left:0;top:0;right:0;bottom:0;
  background:rgba(0,0,0,.45);
  display:flex; align-items:center; justify-content:center;
  z-index:9999;
  padding:12px;
  padding-top:calc(12px + env(safe-area-inset-top));
  padding-bottom:calc(12px + env(safe-area-inset-bottom));
}
.modal{width:100%; max-width:440px;background:#fff;border-radius:14px;padding:12px}
.modal h3{margin:0 0 10px}
.modal .row{margin-bottom:8px}
.modal .btn-row{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}

/* FEEDBACK FASE 2 */
.fase2-attesa{background:#fff7ed;outline:3px solid rgba(251,146,60,.65);box-shadow:0 8px 20px rgba(251,146,60,.18)}
.fase2-ok{background:#f0fdf4;outline:3px solid rgba(34,197,94,.65);box-shadow:0 8px 20px rgba(34,197,94,.18)}

/* FULLSCREEN FASE 3 */
.cards-fullscreen{
  position:fixed;left:0;top:0;right:0;bottom:0;
  background:#f3f4f6;z-index:9998;
  padding:12px;
  padding-top:calc(12px + env(safe-area-inset-top));
  padding-bottom:calc(84px + env(safe-area-inset-bottom));
  overflow:auto;
}
.cards-fullscreen #cards{
  display:grid;
  grid-template-columns:repeat(auto-fill, minmax(320px, 1fr));
  gap:12px;
}

/* GRUPPI PER COMUNE */
.group-title{
  font-size:14px;font-weight:900;padding:8px 10px;border-radius:12px;
  background:rgba(0,0,0,.05);margin:14px 0 8px;
}
.cards-fullscreen .group-title{ grid-column: 1 / -1; }

/* INBOX */
.inbox-item{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:10px;margin-top:8px}
.inbox-title{font-weight:900}
.inbox-sub{font-size:12px;color:#6b7280;margin-top:4px}
.inbox-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}

/* Toast */
.toast{
  position:fixed;left:50%;transform:translateX(-50%);
  bottom:calc(84px + env(safe-area-inset-bottom));
  z-index:10001;background:rgba(17,24,39,.92);color:#fff;
  padding:10px 12px;border-radius:14px;font-size:13px;font-weight:900;
  max-width:min(560px, calc(100% - 24px));text-align:center;display:none;
}

/* Badge versione */
.badge{
  position:fixed;top:calc(8px + env(safe-area-inset-top));right:10px;
  z-index:10000;font-size:11px;font-weight:900;color:#6b7280;
  background:rgba(255,255,255,.85);border:1px solid #e5e7eb;
  padding:4px 8px;border-radius:999px;backdrop-filter: blur(6px);
}

/* TAB BAR */
.tabbar{
  position:fixed;left:0;right:0;bottom:0;z-index:10002;
  background:rgba(255,255,255,.92);
  border-top:1px solid #e5e7eb;
  padding:8px 10px;
  padding-bottom:calc(8px + env(safe-area-inset-bottom));
  backdrop-filter: blur(8px);
}
.tabbar .row{max-width:900px;margin:auto;display:flex;gap:10px;justify-content:space-between}
.tabbtn{
  flex:1;background:#f3f4f6;border-radius:14px;padding:10px 8px;
  font-weight:900;text-align:center;user-select:none;
}
.tabbtn.active{background:#2563eb;color:#fff}
</style>
</head>

<body>
<div id="badge" class="badge">Versione: ‚Äî</div>
<div id="toast" class="toast"></div>

<div class="app">

  <!-- FASE 1 -->
  <div class="card" id="fase1">
    <h3>1. Incolla SMS</h3>
    <textarea id="sms" placeholder="Incolla qui l'SMS..."></textarea>

    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <button id="initBtn" class="btn-primary">‚ñ∂Ô∏è Inizializza</button>
      <button id="clearSmsBtn" class="btn-secondary">üßπ Pulisci SMS</button>
      <span id="led" class="led"></span>
      <span id="ledTxt" style="font-weight:900;color:#6b7280">Non inizializzato</span>
    </div>
  </div>

  <!-- FASE 2 -->
  <div class="card" id="fase2">
    <h3>2. Gestione</h3>

    <!-- IMPORT APPUNTI (SEMPRE VISIBILE) -->
    <div style="background:#eef2ff;border:1px dashed #93c5fd;border-radius:14px;padding:10px;margin:10px 0">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <div style="font-weight:900">üìã Importa SMS dagli Appunti</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="clipImportBtn" class="btn-primary">Importa</button>
          <button id="clipPasteBtn" class="btn-secondary">Incolla</button>
        </div>
      </div>
      <div class="small" style="margin-top:8px;color:#6b7280">
        La scorciatoia deve copiare negli appunti: <b>RAPPORTI_SMS:</b> + testo del messaggio.
      </div>
    </div>

    <!-- Inbox -->
    <div id="inboxWrap" class="hidden" style="background:#f9fafb;border:1px dashed #d1d5db;border-radius:14px;padding:10px;margin:10px 0">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <div style="font-weight:900">üì© SMS in attesa</div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <span id="inboxCount" class="small" style="color:#6b7280"></span>
          <button id="clearInboxBtn" class="btn-danger">üóëÔ∏è Svuota</button>
        </div>
      </div>
      <div id="inboxList"></div>
      <div class="small" style="margin-top:8px;color:#6b7280">
        Tocca <b>Apri</b> su un SMS ‚Üí scegli <b>PROBLEMA</b> e <b>TIPO GESTIONE</b> ‚Üí <b>Aggiungi</b>.
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap">
      <button id="manualModeBtn" class="btn-secondary">‚úçÔ∏è Modalit√† manuale</button>
      <button id="toggleCliente" class="btn-secondary">üëÅÔ∏è Mostra cliente</button>
      <button id="newClientBtn" class="btn-primary">‚ûï Nuovo cliente</button>
    </div>

    <div id="clienteBox" class="hidden">
      <input id="nome" placeholder="Nome">
      <input id="via" placeholder="Via">
      <input id="citta" placeholder="Comune">
      <input id="telefono" placeholder="Telefono" type="tel" inputmode="numeric" autocomplete="tel">
      <input id="modello" placeholder="Modello caldaia">
    </div>

    <select id="problema">
      <option value="">-- PROBLEMA --</option>
      <option>NO ACQUA CALDA</option>
      <option>RISCALDAMENTO NON VA</option>
      <option>RUMOROSA</option>
      <option>PERDITA D'ACQUA</option>
      <option>TUTTO FERMO</option>
      <option>ALTRO</option>
    </select>
    <input id="problemaAltro" class="hidden" placeholder="Scrivi il problema...">

    <select id="stato">
      <option value="">-- TIPO GESTIONE --</option>
      <option value="telefonica">GESTITA AL TELEFONO</option>
      <option value="richiamare">RICHIAMANO LORO</option>
      <option value="da_richiamare">DA RICHIAMARE</option>
      <option value="uscita">USCITA</option>
      <option value="rifiutato">RIFIUTATO</option>
      <option value="ripartita">RIPARTITA</option>
    </select>

    <input id="note" placeholder="Note">

    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button id="addBtn" class="btn-primary">‚ûï Aggiungi alla lista</button>
      <button id="clearFieldsBtn" class="btn-secondary">üßπ Pulisci campi</button>
    </div>
  </div>

  <!-- FASE 3 -->
  <div class="card" id="fase3">
    <h3>3. Clienti</h3>

    <!-- Notifiche duplicati -->
    <div id="dupWrap" class="hidden" style="background:#fff7ed;border:1px dashed #fdba74;border-radius:14px;padding:10px;margin:10px 0">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <div style="font-weight:900">‚ö†Ô∏è SMS gi√† presenti (cliente in lista)</div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <span id="dupCount" class="small" style="color:#6b7280"></span>
          <button id="clearDupBtn" class="btn-danger">üóëÔ∏è Svuota</button>
        </div>
      </div>
      <div id="dupList"></div>
      <div class="small" style="margin-top:8px;color:#6b7280">
        La card resta evidenziata finch√© non elimini la notifica.
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap">
      <button class="btn-secondary" id="fsBtn">üñ•Ô∏è Schermo intero</button>
      <button class="btn-danger" id="delAllBtn">üóëÔ∏è Elimina tutto</button>
    </div>

    <div id="cards"></div>
  </div>

</div>

<!-- TAB BAR -->
<div class="tabbar">
  <div class="row">
    <div id="tab1" class="tabbtn">üìù SMS</div>
    <div id="tab2" class="tabbtn">‚öôÔ∏è Gestione</div>
    <div id="tab3" class="tabbtn">üë• Clienti</div>
  </div>
</div>

<div id="modalRoot" class="hidden"></div>

<script>
/* =======================
   VERSIONE (cambiala quando modifichi)
   ======================= */
var APP_VERSION = "2025-12-26.20";
var APP_BUILD   = "2025-12-26 23:20";
/* SW_VER deve combaciare con service-worker.js CACHE_VERSION v20 */
var SW_VER      = 20;

function $(id){ return document.getElementById(id); }
function safeTrim(s){ return (s||"").replace(/^\s+|\s+$/g,""); }

var badge = $("badge");
var toastEl = $("toast");

var fase1 = $("fase1");
var fase2 = $("fase2");
var fase3 = $("fase3");

var tab1 = $("tab1");
var tab2 = $("tab2");
var tab3 = $("tab3");

var sms = $("sms");
var initBtn = $("initBtn");
var clearSmsBtn = $("clearSmsBtn");
var led = $("led");
var ledTxt = $("ledTxt");

var manualModeBtn = $("manualModeBtn");
var toggleCliente = $("toggleCliente");
var newClientBtn = $("newClientBtn");
var clearFieldsBtn = $("clearFieldsBtn");
var clienteBox = $("clienteBox");

var nome = $("nome");
var via = $("via");
var citta = $("citta");
var telefono = $("telefono");
var modello = $("modello");

var problema = $("problema");
var problemaAltro = $("problemaAltro");
var stato = $("stato");
var note = $("note");
var addBtn = $("addBtn");

var inboxWrap = $("inboxWrap");
var inboxList = $("inboxList");
var inboxCount = $("inboxCount");
var clearInboxBtn = $("clearInboxBtn");

var dupWrap = $("dupWrap");
var dupList = $("dupList");
var dupCount = $("dupCount");
var clearDupBtn = $("clearDupBtn");

var clipImportBtn = $("clipImportBtn");
var clipPasteBtn  = $("clipPasteBtn");

var cards = $("cards");
var modalRoot = $("modalRoot");
var fsBtn = $("fsBtn");
var delAllBtn = $("delAllBtn");

/* ===== stato ===== */
var clients = [];
var inbox = [];
var selectedInboxIndex = -1;

var dupNotifs = [];
var dupKeyMap = {};

var manualMode = false;
var fase2Armed = false;

/* ===== toast ===== */
var toastTimer=null;
function showToast(msg){
  toastEl.textContent = msg;
  toastEl.style.display="block";
  if(toastTimer) clearTimeout(toastTimer);
  toastTimer=setTimeout(function(){ toastEl.style.display="none"; }, 2200);
}

/* ===== modale ===== */
function showModal(build){
  modalRoot.innerHTML="";
  modalRoot.classList.remove("hidden");
  var b=document.createElement("div");
  b.className="modal-backdrop";
  var m=document.createElement("div");
  m.className="modal";
  build(m);
  b.appendChild(m);
  modalRoot.appendChild(b);
}
function closeModal(){ modalRoot.classList.add("hidden"); modalRoot.innerHTML=""; }

/* ===== storage ===== */
function salvaDati(){ try{ localStorage.setItem("rapportiClienti", JSON.stringify(clients)); }catch(e){} }
function caricaDati(){ try{ clients = JSON.parse(localStorage.getItem("rapportiClienti")||"[]")||[]; }catch(e){ clients=[]; } }

function salvaInbox(){ try{ localStorage.setItem("rapportiInbox", JSON.stringify(inbox)); }catch(e){} }
function caricaInbox(){ try{ inbox = JSON.parse(localStorage.getItem("rapportiInbox")||"[]")||[]; }catch(e){ inbox=[]; } }

function salvaDup(){ try{ localStorage.setItem("rapportiDupNotifs", JSON.stringify(dupNotifs)); }catch(e){} }
function caricaDup(){ try{ dupNotifs = JSON.parse(localStorage.getItem("rapportiDupNotifs")||"[]")||[]; }catch(e){ dupNotifs=[]; } }

function salvaModo(){ try{ localStorage.setItem("rapportiManualMode", manualMode ? "1":"0"); }catch(e){} }
function caricaModo(){ try{ manualMode = (localStorage.getItem("rapportiManualMode")==="1"); }catch(e){ manualMode=false; } }

/* ===== util ===== */
function cleanPhone(p){ return String(p||"").replace(/[^0-9+]/g,""); }
function normKey(s){ return safeTrim(String(s||"")).toLowerCase().replace(/\s+/g," "); }
function clientKeyFromFields(n,v,c,tel){
  var ph=cleanPhone(tel);
  if(ph) return "tel:"+ph;
  return "addr:"+normKey(n)+"|"+normKey(v)+"|"+normKey(c);
}
function clientKeyFromClientObj(c){ return clientKeyFromFields(c.nome,c.via,c.citta,c.telefono); }
function safeIdFromKey(key){
  var s = String(key||"");
  try{
    var b = btoa(unescape(encodeURIComponent(s))).replace(/=+/g,"").replace(/\+/g,"-").replace(/\//g,"_");
    return "card_"+b;
  }catch(e){
    return "card_"+s.replace(/[^a-z0-9]+/gi,"_").slice(0,80);
  }
}
function findClientIndexByKey(key){
  for(var i=0;i<clients.length;i++){
    if(clientKeyFromClientObj(clients[i])===key) return i;
  }
  return -1;
}

/* ===== parse sms ===== */
function parseSMS(t){
  var r={nome:"",via:"",citta:"",telefono:"",modello:""};
  t=t||"";
  var low=t.toLowerCase();

  var tel=t.match(/tel\.?\s*([0-9 +]+)/i);
  if(tel) r.telefono=tel[1].replace(/\s+/g,"");

  var m=t.match(/modello\s*(.*?)\s*id\b/i);
  if(m) r.modello=safeTrim(m[1]);

  var idx=low.indexOf(" via ");
  if(idx!==-1){
    r.nome=safeTrim(t.substring(0,idx));
    var rest=t.substring(idx+1);
    var civ=rest.match(/(\d+)/);
    if(civ){
      r.via=safeTrim(rest.substring(0,civ.index+civ[1].length));
      r.citta=safeTrim(rest.substring(civ.index+civ[1].length).replace(/tel.*/i,""));
    }
  }
  return r;
}

/* ===== badge versione ===== */
function renderVersion(){
  badge.textContent = "Versione: " + APP_VERSION + " ‚Ä¢ Build: " + APP_BUILD + " ‚Ä¢ SW:" + SW_VER;
}

/* ===== tab nav ===== */
function setActiveTab(id){
  tab1.classList.remove("active"); tab2.classList.remove("active"); tab3.classList.remove("active");
  if(id==="fase1") tab1.classList.add("active");
  if(id==="fase2") tab2.classList.add("active");
  if(id==="fase3") tab3.classList.add("active");
}
function goTab(id){
  var el=$(id); if(!el) return;
  setActiveTab(id);
  try{ el.scrollIntoView({behavior:"smooth", block:"start"}); }catch(e){}
}
tab1.onclick=function(){ goTab("fase1"); };
tab2.onclick=function(){ goTab("fase2"); };
tab3.onclick=function(){ goTab("fase3"); };

/* ===== led ===== */
function setLedOk(on){
  if(on){
    led.classList.add("ok");
    ledTxt.textContent="‚úÖ Inizializzato";
    ledTxt.style.color="#16a34a";
  }else{
    led.classList.remove("ok");
    ledTxt.textContent="Non inizializzato";
    ledTxt.style.color="#6b7280";
  }
}

/* ===== fase2 feedback ===== */
function setFase2State(state){
  fase2.classList.remove("fase2-attesa","fase2-ok");
  if(state==="attesa") fase2.classList.add("fase2-attesa");
  if(state==="ok") fase2.classList.add("fase2-ok");
}
function armFase2(){
  fase2Armed=true;
  setFase2State("attesa");
  checkFase2Ready();
}
function disarmFase2(){ fase2Armed=false; setFase2State("normal"); }
function checkFase2Ready(){
  if(!fase2Armed) return;
  var problemOk = !!problema.value;
  if(problema.value==="ALTRO") problemOk = safeTrim(problemaAltro.value).length>0;
  var statoOk = !!stato.value;
  setFase2State((problemOk && statoOk) ? "ok" : "attesa");
}

/* ===== modalit√† ===== */
function applyMode(){
  if(manualMode){
    fase1.classList.remove("hidden");
    newClientBtn.classList.remove("hidden");
    manualModeBtn.textContent="‚ö° Modalit√† automatica";
  }else{
    fase1.classList.add("hidden");
    newClientBtn.classList.add("hidden");
    manualModeBtn.textContent="‚úçÔ∏è Modalit√† manuale";
  }
  renderInbox();
}
manualModeBtn.onclick=function(){
  manualMode=!manualMode;
  salvaModo();
  applyMode();
};

/* ===== inbox ===== */
function inboxHasRaw(text){
  text=safeTrim(text);
  for(var i=0;i<inbox.length;i++){
    if(safeTrim(inbox[i].raw)===text) return true;
  }
  return false;
}
function addSmsToInbox(raw){
  raw=safeTrim(raw);
  if(!raw) return;
  if(inboxHasRaw(raw)) return;
  inbox.unshift({raw:raw, ts:Date.now()});
  salvaInbox();
  renderInbox();
}
function loadFromSmsText(testo){
  var d=parseSMS(testo);
  clienteBox.classList.remove("hidden");
  nome.value=d.nome; via.value=d.via; citta.value=d.citta; telefono.value=d.telefono; modello.value=d.modello;
  note.value="";
  setLedOk(true);
  armFase2();
}
function renderInbox(){
  if(!inbox.length){
    inboxWrap.classList.add("hidden");
    inboxList.innerHTML="";
    inboxCount.textContent="";
    return;
  }
  inboxWrap.classList.remove("hidden");
  inboxCount.textContent=inbox.length+" in attesa";
  inboxList.innerHTML="";

  for(var i=0;i<inbox.length;i++){
    (function(ii){
      var it=inbox[ii];
      var preview=(it.raw||"").replace(/\s+/g," ").slice(0,140);

      var div=document.createElement("div");
      div.className="inbox-item";
      div.innerHTML =
        '<div class="inbox-title">SMS ‚Ä¢ '+preview+'</div>'+
        '<div class="inbox-sub">Tocca Apri per gestirlo</div>';

      var actions=document.createElement("div");
      actions.className="inbox-actions";

      var openBtn=document.createElement("button");
      openBtn.className="btn-primary";
      openBtn.textContent="Apri";
      openBtn.onclick=function(){
        selectedInboxIndex=ii;
        loadFromSmsText(it.raw);
        goTab("fase2");
      };

      var delBtn=document.createElement("button");
      delBtn.className="btn-danger";
      delBtn.textContent="Elimina";
      delBtn.onclick=function(){
        showModal(function(m){
          m.innerHTML =
            '<h3>Eliminare questo SMS in attesa?</h3>'+
            '<div class="small" style="color:#6b7280;margin-bottom:10px">'+preview+'</div>'+
            '<div class="btn-row">'+
              '<button class="btn-secondary" id="noDelIn">NO</button>'+
              '<button class="btn-danger" id="siDelIn">SI</button>'+
            '</div>';
          m.querySelector("#noDelIn").onclick=closeModal;
          m.querySelector("#siDelIn").onclick=function(){
            inbox.splice(ii,1);
            if(selectedInboxIndex===ii) selectedInboxIndex=-1;
            salvaInbox();
            renderInbox();
            closeModal();
          };
        });
      };

      actions.appendChild(openBtn);
      actions.appendChild(delBtn);
      div.appendChild(actions);
      inboxList.appendChild(div);
    })(i);
  }
}
clearInboxBtn.onclick=function(){
  showModal(function(m){
    m.innerHTML =
      '<h3>Svuotare tutti gli SMS in attesa?</h3>'+
      '<div class="btn-row">'+
        '<button class="btn-secondary" id="noClr">NO</button>'+
        '<button class="btn-danger" id="siClr">SI</button>'+
      '</div>';
    m.querySelector("#noClr").onclick=closeModal;
    m.querySelector("#siClr").onclick=function(){
      inbox=[]; selectedInboxIndex=-1;
      salvaInbox(); renderInbox();
      closeModal();
    };
  });
};

/* ===== duplicati ===== */
function rebuildDupKeyMap(){
  dupKeyMap={};
  for(var i=0;i<dupNotifs.length;i++){
    if(dupNotifs[i].key) dupKeyMap[dupNotifs[i].key]=true;
  }
}
function isDupKey(key){ return !!dupKeyMap[key]; }
function dupHasRaw(text){
  text=safeTrim(text);
  for(var i=0;i<dupNotifs.length;i++){
    if(safeTrim(dupNotifs[i].raw)===text) return true;
  }
  return false;
}
function addDupNotif(raw, key){
  raw=safeTrim(raw);
  if(!raw||!key) return;
  if(dupHasRaw(raw)) return;
  dupNotifs.unshift({raw:raw, key:key, ts:Date.now()});
  salvaDup();
  rebuildDupKeyMap();
  render();
  renderDup();
}
function renderDup(){
  if(!dupNotifs.length){
    dupWrap.classList.add("hidden");
    dupList.innerHTML="";
    dupCount.textContent="";
    return;
  }
  dupWrap.classList.remove("hidden");
  dupCount.textContent=dupNotifs.length+" notifica/e";
  dupList.innerHTML="";

  for(var i=0;i<dupNotifs.length;i++){
    (function(ii){
      var it=dupNotifs[ii];
      var preview=(it.raw||"").replace(/\s+/g," ").slice(0,140);

      var div=document.createElement("div");
      div.className="inbox-item";
      div.innerHTML =
        '<div class="inbox-title">SMS duplicato ‚Ä¢ '+preview+'</div>'+
        '<div class="inbox-sub">Cliente gi√† presente: evidenziato finch√© elimini la notifica</div>';

      var actions=document.createElement("div");
      actions.className="inbox-actions";

      var goBtn=document.createElement("button");
      goBtn.className="btn-primary";
      goBtn.textContent="Vai al cliente";
      goBtn.onclick=function(){
        render();
        highlightClient(it.key);
        goTab("fase3");
      };

      var delBtn=document.createElement("button");
      delBtn.className="btn-danger";
      delBtn.textContent="Elimina notifica";
      delBtn.onclick=function(){
        showModal(function(m){
          m.innerHTML =
            '<h3>Eliminare questa notifica?</h3>'+
            '<div class="small" style="color:#6b7280;margin-bottom:10px">'+preview+'</div>'+
            '<div class="btn-row">'+
              '<button class="btn-secondary" id="noDelDup">NO</button>'+
              '<button class="btn-danger" id="siDelDup">SI</button>'+
            '</div>';
          m.querySelector("#noDelDup").onclick=closeModal;
          m.querySelector("#siDelDup").onclick=function(){
            dupNotifs.splice(ii,1);
            salvaDup();
            rebuildDupKeyMap();
            closeModal();
            render();
            renderDup();
          };
        });
      };

      actions.appendChild(goBtn);
      actions.appendChild(delBtn);
      div.appendChild(actions);
      dupList.appendChild(div);
    })(i);
  }
}
clearDupBtn.onclick=function(){
  showModal(function(m){
    m.innerHTML =
      '<h3>Svuotare tutte le notifiche?</h3>'+
      '<div class="btn-row">'+
        '<button class="btn-secondary" id="noClrDup">NO</button>'+
        '<button class="btn-danger" id="siClrDup">SI</button>'+
      '</div>';
    m.querySelector("#noClrDup").onclick=closeModal;
    m.querySelector("#siClrDup").onclick=function(){
      dupNotifs=[];
      salvaDup();
      rebuildDupKeyMap();
      closeModal();
      render();
      renderDup();
    };
  });
};

function highlightClient(key){
  var id=safeIdFromKey(key);
  var el=document.getElementById(id);
  if(!el) return;
  el.classList.add("gc-highlight");
  try{ el.scrollIntoView({behavior:"smooth", block:"center"}); }catch(e){}
}

/* ===== render clienti ===== */
function statoLabel(s){
  var map={
    telefonica:"GESTITA AL TELEFONO",
    richiamare:"RICHIAMANO LORO",
    da_richiamare:"DA RICHIAMARE",
    uscita:"USCITA",
    rifiutato:"RIFIUTATO",
    ripartita:"RIPARTITA"
  };
  return map[s]||"DA DECIDERE";
}
function row(t){
  var r=document.createElement("div");
  r.className="gc-row";
  r.textContent=t;
  return r;
}
function buildCard(c, idx){
  var d=document.createElement("div");
  d.className="gc-card gc-"+(c.stato||"none");

  var key=clientKeyFromClientObj(c);
  d.id = safeIdFromKey(key);
  if(isDupKey(key)) d.classList.add("gc-highlight");

  var st=document.createElement("span");
  st.className="gc-stato";
  st.textContent=statoLabel(c.stato);
  st.onclick=function(){
    var s=document.createElement("select");
    s.innerHTML=stato.innerHTML;
    s.value=c.stato||"";
    st.parentNode.replaceChild(s, st);
    try{ s.focus(); }catch(e){}
    s.onchange=function(){ c.stato=s.value; salvaDati(); render(); };
  };
  d.appendChild(st);

  var title=document.createElement("div");
  title.className="gc-title";
  title.textContent=c.nome||"";
  d.appendChild(title);

  var addr="";
  if(c.via) addr+=c.via;
  if(c.citta) addr+=(addr?" - ":"")+c.citta;
  if(addr){
    var a=document.createElement("div");
    a.className="gc-big gc-link";
    a.textContent="üìç "+addr;
    a.onclick=function(){
      window.open("https://www.google.com/maps/search/?api=1&query="+encodeURIComponent(addr));
    };
    d.appendChild(a);
  }

  if(c.telefono){
    var ph=cleanPhone(c.telefono);
    var t=document.createElement("a");
    t.className="gc-big gc-link";
    t.textContent="üìû "+ph;
    t.href="tel:%2331%23"+ph;
    d.appendChild(t);
  }

  if(c.modello) d.appendChild(row("üî• Modello: "+c.modello));
  if(c.problema) d.appendChild(row("‚ùó Problema: "+c.problema));
  if(c.note) d.appendChild(row("üìù Note: "+c.note));

  var act=document.createElement("div");
  act.className="gc-actions";

  var del=document.createElement("button");
  del.className="btn-danger";
  del.textContent="üóëÔ∏è Elimina";
  del.onclick=function(){ deleteClient(idx); };

  act.appendChild(del);
  d.appendChild(act);

  return d;
}
function render(){
  cards.innerHTML="";

  var order=[];
  var groups={};

  for(var i=0;i<clients.length;i++){
    var c=clients[i];
    var raw=safeTrim(c.citta);
    var key = raw ? raw.toLowerCase() : "__no_city__";
    if(!groups[key]){
      groups[key]={label: raw || "SENZA COMUNE", items:[]};
      order.push(key);
    }
    groups[key].items.push({c:c, idx:i});
  }

  for(var k=0;k<order.length;k++){
    var g=groups[order[k]];
    var header=document.createElement("div");
    header.className="group-title";
    header.textContent="üèòÔ∏è "+g.label;
    cards.appendChild(header);

    for(var j=0;j<g.items.length;j++){
      cards.appendChild(buildCard(g.items[j].c, g.items[j].idx));
    }
  }
}

/* ===== delete ===== */
function deleteClient(i){
  showModal(function(m){
    m.innerHTML =
      '<h3>Eliminare cliente?</h3>'+
      '<div class="btn-row">'+
        '<button class="btn-secondary" id="noDel">NO</button>'+
        '<button class="btn-danger" id="siDel">SI</button>'+
      '</div>';
    m.querySelector("#noDel").onclick=closeModal;
    m.querySelector("#siDel").onclick=function(){
      clients.splice(i,1);
      salvaDati();
      closeModal();
      render();
    };
  });
}
function deleteAll(){
  showModal(function(m){
    m.innerHTML =
      '<h3>Eliminare TUTTI i clienti?</h3>'+
      '<div class="btn-row">'+
        '<button class="btn-secondary" id="noAll">NO</button>'+
        '<button class="btn-danger" id="siAll">SI</button>'+
      '</div>';
    m.querySelector("#noAll").onclick=closeModal;
    m.querySelector("#siAll").onclick=function(){
      clients=[];
      salvaDati();
      closeModal();
      render();
    };
  });
}
delAllBtn.onclick=deleteAll;

/* ===== fullscreen ===== */
fsBtn.onclick=function(){
  if(fase3.classList.contains("cards-fullscreen")){
    fase3.classList.remove("cards-fullscreen");
    fsBtn.textContent="üñ•Ô∏è Schermo intero";
  }else{
    fase3.classList.add("cards-fullscreen");
    fsBtn.textContent="‚ùå Esci";
  }
};

/* ===== reset UI ===== */
function resetCampi(){
  nome.value=""; via.value=""; citta.value=""; telefono.value=""; modello.value="";
  problema.value=""; problemaAltro.value=""; problemaAltro.classList.add("hidden");
  stato.value=""; note.value="";
}
function resetUI(){
  resetCampi();
  sms.value="";
  setLedOk(false);
  clienteBox.classList.add("hidden");
  disarmFase2();
  selectedInboxIndex=-1;
}

/* ===== FASE 1 ===== */
initBtn.onclick=function(){
  var testo=safeTrim(sms.value);
  if(!testo){ alert("Incolla prima l'SMS."); return; }

  var d=parseSMS(testo);
  clienteBox.classList.remove("hidden");
  nome.value=d.nome; via.value=d.via; citta.value=d.citta; telefono.value=d.telefono; modello.value=d.modello;

  setLedOk(true);
  armFase2();
  goTab("fase2");
};
clearSmsBtn.onclick=function(){ resetUI(); };

/* ===== FASE 2 UI ===== */
toggleCliente.onclick=function(){
  if(clienteBox.classList.contains("hidden")) clienteBox.classList.remove("hidden");
  else clienteBox.classList.add("hidden");
};
newClientBtn.onclick=function(){
  clienteBox.classList.remove("hidden");
  resetCampi();
  sms.value="";
  setLedOk(false);
  armFase2();
};

problema.onchange=function(){
  if(problema.value==="ALTRO"){
    problemaAltro.classList.remove("hidden");
    try{ problemaAltro.focus(); }catch(e){}
  }else{
    problemaAltro.value="";
    problemaAltro.classList.add("hidden");
  }
  checkFase2Ready();
};
problemaAltro.oninput=function(){ checkFase2Ready(); };
stato.onchange=function(){ checkFase2Ready(); };

clearFieldsBtn.onclick=function(){
  resetUI();
  applyMode();
};

/* ===== aggiungi cliente ===== */
addBtn.onclick=function(){
  var problemOk=!!problema.value;
  if(problema.value==="ALTRO") problemOk = safeTrim(problemaAltro.value).length>0;
  if(!problemOk || !stato.value){
    alert("Seleziona PROBLEMA e TIPO GESTIONE. Se scegli ALTRO, scrivi il problema.");
    return;
  }

  var problemaFinale = problema.value;
  if(problema.value==="ALTRO") problemaFinale = "ALTRO: " + safeTrim(problemaAltro.value);

  var key = clientKeyFromFields(nome.value, via.value, citta.value, telefono.value);
  if(findClientIndexByKey(key)>=0){
    showToast("‚ö†Ô∏è Cliente gi√† presente: non aggiunto");
    render();
    goTab("fase3");
    highlightClient(key);
    return;
  }

  clients.push({
    nome:nome.value,
    via:via.value,
    citta:citta.value,
    telefono:telefono.value,
    modello:modello.value,
    problema:problemaFinale,
    stato:stato.value,
    note:note.value
  });

  if(selectedInboxIndex>=0){
    inbox.splice(selectedInboxIndex,1);
    selectedInboxIndex=-1;
    salvaInbox();
    renderInbox();
  }

  salvaDati();
  render();
  resetUI();
  applyMode();
  showToast("‚úÖ Aggiunto");
  goTab("fase3");
};

/* ===== IMPORT APPUNTI ===== */
var CLIP_PREFIX="RAPPORTI_SMS:";

function normalizeClipboardPayload(txt){
  txt=safeTrim(txt);
  if(!txt) return "";
  if(txt.indexOf(CLIP_PREFIX)===0) return safeTrim(txt.substring(CLIP_PREFIX.length));
  return "";
}
async function readClipboardText(){
  if(!navigator.clipboard || !navigator.clipboard.readText) return "";
  try{ return String(await navigator.clipboard.readText()||""); }catch(e){ return ""; }
}
function shouldSkipAlreadyImported(raw){
  try{ return (localStorage.getItem("lastImportedSmsRaw")||"")===raw; }catch(e){ return false; }
}
function markImported(raw){ try{ localStorage.setItem("lastImportedSmsRaw", raw); }catch(e){} }

function handleIncomingSmsText(raw){
  raw=safeTrim(raw);
  if(!raw) return false;

  if(shouldSkipAlreadyImported(raw)) return true;
  markImported(raw);

  var parsed=parseSMS(raw);
  var key=clientKeyFromFields(parsed.nome, parsed.via, parsed.citta, parsed.telefono);
  var existingIdx=findClientIndexByKey(key);

  if(existingIdx>=0){
    addDupNotif(raw, key);
    showToast("‚ö†Ô∏è Cliente gi√† presente: notifica in FASE 3");
    render();
    renderDup();
    goTab("fase3");
    highlightClient(key);
    return true;
  }

  addSmsToInbox(raw);
  manualMode=false;
  salvaModo();
  applyMode();
  showToast("‚úÖ SMS messo in attesa");
  goTab("fase2");
  return true;
}

clipImportBtn.onclick = async function(){
  var t = await readClipboardText();
  var payload = normalizeClipboardPayload(t);
  if(!payload){
    showToast("Nessun SMS valido negli appunti (manca RAPPORTI_SMS:)");
    return;
  }
  handleIncomingSmsText(payload);
};

clipPasteBtn.onclick = function(){
  showModal(function(m){
    m.innerHTML =
      '<h3>Incolla SMS</h3>'+
      '<div class="small" style="color:#6b7280;margin-bottom:8px">Incolla qui l‚ÄôSMS (anche senza prefisso), poi Importa.</div>'+
      '<textarea id="m_paste" style="height:140px;width:100%;padding:10px;border-radius:10px;border:1px solid #d1d5db"></textarea>'+
      '<div class="btn-row" style="margin-top:10px">'+
        '<button class="btn-secondary" id="m_cancel">Annulla</button>'+
        '<button class="btn-primary" id="m_ok">Importa</button>'+
      '</div>';
    m.querySelector("#m_cancel").onclick=closeModal;
    m.querySelector("#m_ok").onclick=function(){
      var raw = safeTrim(m.querySelector("#m_paste").value);
      if(!raw){ alert("Incolla prima l'SMS."); return; }
      closeModal();
      handleIncomingSmsText(raw);
    };
  });
};

/* ===== INIT ===== */
function boot(){
  caricaDati();
  caricaInbox();
  caricaDup();
  rebuildDupKeyMap();
  caricaModo();

  if(localStorage.getItem("rapportiManualMode")===null){
    manualMode=false;
    salvaModo();
  }

  render();
  renderInbox();
  renderDup();
  applyMode();

  renderVersion();
  setActiveTab(manualMode ? "fase1" : "fase2");
}
boot();

/* ===== SERVICE WORKER ===== */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", function () {
    navigator.serviceWorker.register("service-worker.js?v=" + SW_VER).catch(function(){});
  });
}
</script>
</body>
</html>
